


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html id="htmlId">
<head>
  <title>Coverage Report :: ProjectBrowser</title>
  <style type="text/css">
    @import "../../.css/coverage.css";
  </style>
</head>

<body>
<div class="header"></div>

<div class="content">
<div class="breadCrumbs">
    [ <a href="../../index.html">all classes</a> ]
    [ <a href="../index.html">qupath.lib.gui.panes</a> ]
</div>

<h1>Coverage Summary for Class: ProjectBrowser (qupath.lib.gui.panes)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ProjectBrowser</td>
<td class="coverageStat">
  <span class="percent">
    20%
  </span>
  <span class="absValue">
    (9/ 45)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    18.4%
  </span>
  <span class="absValue">
    (93/ 505)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ProjectBrowser$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ProjectBrowser$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ProjectBrowser$ImageEntryCell</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/ 4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    46.4%
  </span>
  <span class="absValue">
    (26/ 56)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ProjectBrowser$ProjectImageTreeModel</td>
<td class="coverageStat">
  <span class="percent">
    15.4%
  </span>
  <span class="absValue">
    (2/ 13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    13%
  </span>
  <span class="absValue">
    (15/ 115)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ProjectBrowser$ProjectThumbnailSize</td>
<td class="coverageStat">
  <span class="percent">
    80%
  </span>
  <span class="absValue">
    (4/ 5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    40%
  </span>
  <span class="absValue">
    (6/ 15)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>total</strong></td>
<td class="coverageStat">
  <span class="percent">
    31.4%
  </span>
  <span class="absValue">
    (22/ 70)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    20.6%
  </span>
  <span class="absValue">
    (143/ 694)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<div class="sourceCode"><i>1</i>&nbsp;/*-
<i>2</i>&nbsp; * #%L
<i>3</i>&nbsp; * This file is part of QuPath.
<i>4</i>&nbsp; * %%
<i>5</i>&nbsp; * Copyright (C) 2014 - 2016 The Queen&#39;s University of Belfast, Northern Ireland
<i>6</i>&nbsp; * Contact: IP Management (ipmanagement@qub.ac.uk)
<i>7</i>&nbsp; * Copyright (C) 2018 - 2020 QuPath developers, The University of Edinburgh
<i>8</i>&nbsp; * %%
<i>9</i>&nbsp; * QuPath is free software: you can redistribute it and/or modify
<i>10</i>&nbsp; * it under the terms of the GNU General Public License as
<i>11</i>&nbsp; * published by the Free Software Foundation, either version 3 of the
<i>12</i>&nbsp; * License, or (at your option) any later version.
<i>13</i>&nbsp; * 
<i>14</i>&nbsp; * QuPath is distributed in the hope that it will be useful,
<i>15</i>&nbsp; * but WITHOUT ANY WARRANTY; without even the implied warranty of
<i>16</i>&nbsp; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<i>17</i>&nbsp; * GNU General Public License for more details.
<i>18</i>&nbsp; * 
<i>19</i>&nbsp; * You should have received a copy of the GNU General Public License 
<i>20</i>&nbsp; * along with QuPath.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
<i>21</i>&nbsp; * #L%
<i>22</i>&nbsp; */
<i>23</i>&nbsp;
<i>24</i>&nbsp;package qupath.lib.gui.panes;
<i>25</i>&nbsp;
<i>26</i>&nbsp;import java.awt.Desktop;
<i>27</i>&nbsp;import java.awt.Graphics2D;
<i>28</i>&nbsp;import java.awt.RenderingHints;
<i>29</i>&nbsp;import java.awt.image.BufferedImage;
<i>30</i>&nbsp;import java.io.File;
<i>31</i>&nbsp;import java.io.IOException;
<i>32</i>&nbsp;import java.net.URI;
<i>33</i>&nbsp;import java.nio.file.Path;
<i>34</i>&nbsp;import java.text.SimpleDateFormat;
<i>35</i>&nbsp;import java.util.ArrayList;
<i>36</i>&nbsp;import java.util.Collection;
<i>37</i>&nbsp;import java.util.Collections;
<i>38</i>&nbsp;import java.util.HashMap;
<i>39</i>&nbsp;import java.util.HashSet;
<i>40</i>&nbsp;import java.util.List;
<i>41</i>&nbsp;import java.util.Map;
<i>42</i>&nbsp;import java.util.Optional;
<i>43</i>&nbsp;import java.util.Random;
<i>44</i>&nbsp;import java.util.Set;
<i>45</i>&nbsp;import java.util.TreeMap;
<i>46</i>&nbsp;import java.util.function.Supplier;
<i>47</i>&nbsp;import java.util.stream.Collectors;
<i>48</i>&nbsp;
<i>49</i>&nbsp;import javax.imageio.ImageIO;
<i>50</i>&nbsp;
<i>51</i>&nbsp;import org.controlsfx.control.MasterDetailPane;
<i>52</i>&nbsp;import org.controlsfx.control.action.Action;
<i>53</i>&nbsp;import org.controlsfx.control.action.ActionUtils;
<i>54</i>&nbsp;import org.controlsfx.control.textfield.TextFields;
<i>55</i>&nbsp;import org.slf4j.Logger;
<i>56</i>&nbsp;import org.slf4j.LoggerFactory;
<i>57</i>&nbsp;
<i>58</i>&nbsp;
<i>59</i>&nbsp;import javafx.application.Platform;
<i>60</i>&nbsp;import javafx.beans.binding.Bindings;
<i>61</i>&nbsp;import javafx.beans.binding.DoubleBinding;
<i>62</i>&nbsp;import javafx.beans.property.ObjectProperty;
<i>63</i>&nbsp;import javafx.beans.property.SimpleStringProperty;
<i>64</i>&nbsp;import javafx.beans.property.StringProperty;
<i>65</i>&nbsp;import javafx.beans.value.ChangeListener;
<i>66</i>&nbsp;import javafx.beans.value.ObservableValue;
<i>67</i>&nbsp;import javafx.collections.FXCollections;
<i>68</i>&nbsp;import javafx.embed.swing.SwingFXUtils;
<i>69</i>&nbsp;import javafx.geometry.Insets;
<i>70</i>&nbsp;import javafx.geometry.Side;
<i>71</i>&nbsp;import javafx.scene.canvas.Canvas;
<i>72</i>&nbsp;import javafx.scene.control.Button;
<i>73</i>&nbsp;import javafx.scene.control.ButtonType;
<i>74</i>&nbsp;import javafx.scene.control.ContextMenu;
<i>75</i>&nbsp;import javafx.scene.control.Dialog;
<i>76</i>&nbsp;import javafx.scene.control.Label;
<i>77</i>&nbsp;import javafx.scene.control.Menu;
<i>78</i>&nbsp;import javafx.scene.control.MenuItem;
<i>79</i>&nbsp;import javafx.scene.control.SelectionMode;
<i>80</i>&nbsp;import javafx.scene.control.SeparatorMenuItem;
<i>81</i>&nbsp;import javafx.scene.control.TextArea;
<i>82</i>&nbsp;import javafx.scene.control.TextField;
<i>83</i>&nbsp;import javafx.scene.control.TitledPane;
<i>84</i>&nbsp;import javafx.scene.control.Tooltip;
<i>85</i>&nbsp;import javafx.scene.control.TreeCell;
<i>86</i>&nbsp;import javafx.scene.control.TreeItem;
<i>87</i>&nbsp;import javafx.scene.control.TreeView;
<i>88</i>&nbsp;import javafx.scene.image.Image;
<i>89</i>&nbsp;import javafx.scene.image.ImageView;
<i>90</i>&nbsp;import javafx.scene.input.KeyCode;
<i>91</i>&nbsp;import javafx.scene.layout.BorderPane;
<i>92</i>&nbsp;import javafx.scene.layout.GridPane;
<i>93</i>&nbsp;import javafx.scene.layout.Pane;
<i>94</i>&nbsp;import javafx.scene.layout.StackPane;
<i>95</i>&nbsp;import javafx.util.Callback;
<i>96</i>&nbsp;import qupath.lib.common.GeneralTools;
<i>97</i>&nbsp;import qupath.lib.gui.ActionTools;
<i>98</i>&nbsp;import qupath.lib.gui.QuPathGUI;
<i>99</i>&nbsp;import qupath.lib.gui.commands.ProjectCommands;
<i>100</i>&nbsp;import qupath.lib.gui.dialogs.Dialogs;
<i>101</i>&nbsp;import qupath.lib.gui.dialogs.Dialogs.DialogButton;
<i>102</i>&nbsp;import qupath.lib.gui.prefs.PathPrefs;
<i>103</i>&nbsp;import qupath.lib.gui.tools.GuiTools;
<i>104</i>&nbsp;import qupath.lib.gui.tools.MenuTools;
<i>105</i>&nbsp;import qupath.lib.gui.tools.PaneTools;
<i>106</i>&nbsp;import qupath.lib.images.ImageData;
<i>107</i>&nbsp;import qupath.lib.images.servers.ImageServer;
<i>108</i>&nbsp;import qupath.lib.images.servers.ImageServerProvider;
<i>109</i>&nbsp;import qupath.lib.plugins.parameters.ParameterList;
<i>110</i>&nbsp;import qupath.lib.projects.Project;
<i>111</i>&nbsp;import qupath.lib.projects.ProjectIO;
<i>112</i>&nbsp;import qupath.lib.projects.ProjectImageEntry;
<i>113</i>&nbsp;import qupath.lib.projects.Projects;
<i>114</i>&nbsp;
<i>115</i>&nbsp;/**
<i>116</i>&nbsp; * Component for previewing and selecting images within a project.
<i>117</i>&nbsp; * 
<i>118</i>&nbsp; * @author Pete Bankhead
<i>119</i>&nbsp; *
<i>120</i>&nbsp; */
<i>121</i>&nbsp;public class ProjectBrowser implements ChangeListener&lt;ImageData&lt;BufferedImage&gt;&gt; {
<i>122</i>&nbsp;
<i>123</i>&nbsp;	final static String THUMBNAIL_EXT = &quot;jpg&quot;;
<i>124</i>&nbsp;
<b class="fc"><i>125</i>&nbsp;	final private static Logger logger = LoggerFactory.getLogger(ProjectBrowser.class);</b>
<i>126</i>&nbsp;
<i>127</i>&nbsp;	private Project&lt;BufferedImage&gt; project;
<i>128</i>&nbsp;
<i>129</i>&nbsp;	// Requested thumbnail max dimensions
<b class="fc"><i>130</i>&nbsp;	private int thumbnailWidth = 1000;</b>
<b class="fc"><i>131</i>&nbsp;	private int thumbnailHeight = 600;</b>
<i>132</i>&nbsp;
<i>133</i>&nbsp;	private QuPathGUI qupath;
<i>134</i>&nbsp;	private BorderPane panel;
<i>135</i>&nbsp;
<b class="fc"><i>136</i>&nbsp;	private ProjectImageTreeModel model = new ProjectImageTreeModel(null);</b>
<b class="fc"><i>137</i>&nbsp;	private TreeView&lt;Object&gt; tree = new TreeView&lt;&gt;();</b>
<i>138</i>&nbsp;
<i>139</i>&nbsp;	// Keep a record of servers we&#39;ve requested - don&#39;t want to keep putting in requests if the server is unavailable
<b class="fc"><i>140</i>&nbsp;	private Set&lt;String&gt; serversRequested = new HashSet&lt;&gt;();</b>
<i>141</i>&nbsp;	
<b class="fc"><i>142</i>&nbsp;	private StringProperty descriptionText = new SimpleStringProperty();</b>
<i>143</i>&nbsp;	
<i>144</i>&nbsp;	private static TextField tfFilter;
<i>145</i>&nbsp;
<b class="fc"><i>146</i>&nbsp;	private static ObjectProperty&lt;ProjectThumbnailSize&gt; thumbnailSize = PathPrefs.createPersistentPreference(&quot;projectThumbnailSize&quot;,</b>
<i>147</i>&nbsp;			ProjectThumbnailSize.SMALL, ProjectThumbnailSize.class);
<i>148</i>&nbsp;	
<i>149</i>&nbsp;	private static String[] additionalSortKeys;
<i>150</i>&nbsp;	
<i>151</i>&nbsp;	private static final String URI = &quot;URI&quot;;
<i>152</i>&nbsp;	
<i>153</i>&nbsp;	/**
<i>154</i>&nbsp;	 * Constructor.
<i>155</i>&nbsp;	 * @param qupath the current QuPath instance
<i>156</i>&nbsp;	 */
<b class="fc"><i>157</i>&nbsp;	public ProjectBrowser(final QuPathGUI qupath) {</b>
<b class="fc"><i>158</i>&nbsp;		this.project = qupath.getProject();</b>
<b class="fc"><i>159</i>&nbsp;		this.qupath = qupath;</b>
<i>160</i>&nbsp;
<b class="fc"><i>161</i>&nbsp;		qupath.imageDataProperty().addListener(this);</b>
<i>162</i>&nbsp;		
<b class="fc"><i>163</i>&nbsp;		PathPrefs.maskImageNamesProperty().addListener((v, o, n) -&gt; {</b>
<b class="nc"><i>164</i>&nbsp;			tree.refresh();</b>
<b class="nc"><i>165</i>&nbsp;		});</b>
<i>166</i>&nbsp;
<b class="fc"><i>167</i>&nbsp;		panel = new BorderPane();</b>
<i>168</i>&nbsp;
<b class="fc"><i>169</i>&nbsp;		tree.setCellFactory(new Callback&lt;TreeView&lt;Object&gt;, TreeCell&lt;Object&gt;&gt;() {</b>
<i>170</i>&nbsp;			@Override public TreeCell&lt;Object&gt; call(TreeView&lt;Object&gt; treeView) {
<b class="fc"><i>171</i>&nbsp;				return new ImageEntryCell();</b>
<i>172</i>&nbsp;			}
<i>173</i>&nbsp;		});
<i>174</i>&nbsp;		
<b class="fc"><i>175</i>&nbsp;		thumbnailSize.addListener((v, o, n) -&gt; tree.refresh());</b>
<i>176</i>&nbsp;
<b class="fc"><i>177</i>&nbsp;		tree.setRoot(null);</b>
<i>178</i>&nbsp;
<b class="fc"><i>179</i>&nbsp;		tree.setContextMenu(getPopup());</b>
<i>180</i>&nbsp;
<b class="fc"><i>181</i>&nbsp;		tree.setOnKeyPressed(e -&gt; {</b>
<b class="nc"><i>182</i>&nbsp;			if (e.getCode() == KeyCode.ENTER) {</b>
<b class="nc"><i>183</i>&nbsp;				qupath.openImageEntry(getSelectedEntry());</b>
<b class="nc"><i>184</i>&nbsp;				e.consume();</b>
<i>185</i>&nbsp;			}
<b class="nc"><i>186</i>&nbsp;		});</b>
<i>187</i>&nbsp;
<b class="fc"><i>188</i>&nbsp;		tree.setOnMouseClicked(e -&gt; {</b>
<b class="nc"><i>189</i>&nbsp;			if (e.getClickCount() &gt; 1) {</b>
<b class="nc"><i>190</i>&nbsp;				qupath.openImageEntry(getSelectedEntry());</b>
<b class="nc"><i>191</i>&nbsp;				e.consume();</b>
<i>192</i>&nbsp;			}
<b class="nc"><i>193</i>&nbsp;		});</b>
<i>194</i>&nbsp;		
<i>195</i>&nbsp;//		TextArea textDescription = new TextArea();
<b class="fc"><i>196</i>&nbsp;		TextArea textDescription = new TextArea();</b>
<b class="fc"><i>197</i>&nbsp;		textDescription.textProperty().bind(descriptionText);</b>
<b class="fc"><i>198</i>&nbsp;		MasterDetailPane mdTree = new MasterDetailPane(Side.BOTTOM, tree, textDescription, false);</b>
<b class="fc"><i>199</i>&nbsp;		mdTree.showDetailNodeProperty().bind(descriptionText.isNotNull());</b>
<i>200</i>&nbsp;		
<b class="fc"><i>201</i>&nbsp;		tree.getSelectionModel().setSelectionMode(SelectionMode.MULTIPLE);</b>
<b class="fc"><i>202</i>&nbsp;		tree.getSelectionModel().selectedItemProperty().addListener((v, o, n) -&gt; {</b>
<b class="nc"><i>203</i>&nbsp;			Object selected = n == null ? null : n.getValue();</b>
<b class="nc"><i>204</i>&nbsp;			if (selected instanceof ProjectImageEntry)</b>
<b class="nc"><i>205</i>&nbsp;				descriptionText.set(((ProjectImageEntry&lt;?&gt;)selected).getDescription());</b>
<i>206</i>&nbsp;			else
<b class="nc"><i>207</i>&nbsp;				descriptionText.set(null);</b>
<b class="nc"><i>208</i>&nbsp;		});</b>
<i>209</i>&nbsp;
<b class="fc"><i>210</i>&nbsp;		TitledPane titledTree = new TitledPane(&quot;Image list&quot;, mdTree);</b>
<b class="fc"><i>211</i>&nbsp;		titledTree.setCollapsible(false);</b>
<b class="fc"><i>212</i>&nbsp;		titledTree.setMaxHeight(Double.MAX_VALUE);</b>
<i>213</i>&nbsp;		
<i>214</i>&nbsp;		
<b class="fc"><i>215</i>&nbsp;		tfFilter = new TextField();</b>
<b class="fc"><i>216</i>&nbsp;		tfFilter.setPromptText(&quot;Search entry in project&quot;);</b>
<b class="fc"><i>217</i>&nbsp;		tfFilter.setTooltip(new Tooltip(&quot;Type some text to filter the project entries by name or type.&quot;));</b>
<i>218</i>&nbsp;		
<b class="fc"><i>219</i>&nbsp;		tfFilter.textProperty().addListener((m, o, n) -&gt; {</b>
<b class="nc"><i>220</i>&nbsp;			model.rebuildModel();</b>
<b class="nc"><i>221</i>&nbsp;			tree.setRoot(model.getRootFX());</b>
<b class="nc"><i>222</i>&nbsp;			tree.getRoot().setExpanded(true);</b>
<i>223</i>&nbsp;			
<i>224</i>&nbsp;			// If user has entered keyword(s) for search and some entries match, 
<i>225</i>&nbsp;			// expand the first TreeItem that contains relevant matches.
<i>226</i>&nbsp;			try {
<b class="nc"><i>227</i>&nbsp;				var listOfChildren = tree.getRoot().getChildren();</b>
<b class="nc"><i>228</i>&nbsp;				if (tfFilter.getText().length() &gt; 0) {</b>
<b class="nc"><i>229</i>&nbsp;						for (int i = 0; i &lt; listOfChildren.size(); i++) {</b>
<b class="nc"><i>230</i>&nbsp;							if (listOfChildren.get(i).getChildren().size() &gt; 0) {</b>
<b class="nc"><i>231</i>&nbsp;								listOfChildren.get(i).setExpanded(true);</b>
<b class="nc"><i>232</i>&nbsp;								break;</b>
<i>233</i>&nbsp;							}
<i>234</i>&nbsp;					}
<i>235</i>&nbsp;				}
<b class="nc"><i>236</i>&nbsp;			} catch (Exception e) {}</b>
<b class="nc"><i>237</i>&nbsp;		});</b>
<i>238</i>&nbsp;		
<i>239</i>&nbsp;		
<b class="fc"><i>240</i>&nbsp;		var paneUserFilter = PaneTools.createRowGrid(tfFilter);</b>
<i>241</i>&nbsp;		
<b class="fc"><i>242</i>&nbsp;		BorderPane panelTree = new BorderPane();</b>
<b class="fc"><i>243</i>&nbsp;		panelTree.setCenter(titledTree);</b>
<i>244</i>&nbsp;
<b class="fc"><i>245</i>&nbsp;		panel.setBottom(paneUserFilter);</b>
<b class="fc"><i>246</i>&nbsp;		panel.setCenter(panelTree);</b>
<i>247</i>&nbsp;
<b class="fc"><i>248</i>&nbsp;		Button btnOpen = ActionTools.createButton(qupath.lookupActionByText(&quot;Open project&quot;), false);</b>
<b class="fc"><i>249</i>&nbsp;		Button btnCreate = ActionTools.createButton(qupath.lookupActionByText(&quot;Create project&quot;), false);</b>
<b class="fc"><i>250</i>&nbsp;		Button btnAdd = ActionTools.createButton(qupath.lookupActionByText(&quot;Add images&quot;), false);</b>
<b class="fc"><i>251</i>&nbsp;		GridPane paneButtons = PaneTools.createColumnGridControls(btnCreate, btnOpen, btnAdd);</b>
<b class="fc"><i>252</i>&nbsp;		paneButtons.prefWidthProperty().bind(panel.widthProperty());</b>
<b class="fc"><i>253</i>&nbsp;		paneButtons.setPadding(new Insets(5, 5, 5, 5));</b>
<b class="fc"><i>254</i>&nbsp;		panel.setTop(paneButtons);</b>
<i>255</i>&nbsp;		
<b class="fc"><i>256</i>&nbsp;		qupath.getPreferencePane().addChoicePropertyPreference(</b>
<b class="fc"><i>257</i>&nbsp;				thumbnailSize, FXCollections.observableArrayList(ProjectThumbnailSize.values()), ProjectThumbnailSize.class,</b>
<i>258</i>&nbsp;				&quot;Project thumbnails size&quot;, &quot;Appearance&quot;, &quot;Choose thumbnail size for the project pane&quot;);
<i>259</i>&nbsp;		
<b class="fc"><i>260</i>&nbsp;		additionalSortKeys = new String[] {URI};</b>
<i>261</i>&nbsp;
<b class="fc"><i>262</i>&nbsp;	}</b>
<i>263</i>&nbsp;	
<i>264</i>&nbsp;	private static String getUserFilter() {
<b class="nc"><i>265</i>&nbsp;		return tfFilter.getText().toLowerCase();</b>
<i>266</i>&nbsp;	}
<i>267</i>&nbsp;
<i>268</i>&nbsp;
<i>269</i>&nbsp;
<i>270</i>&nbsp;	ContextMenu getPopup() {
<i>271</i>&nbsp;		
<b class="fc"><i>272</i>&nbsp;		Action actionOpenImage = new Action(&quot;Open image&quot;, e -&gt; qupath.openImageEntry(getSelectedEntry()));</b>
<b class="fc"><i>273</i>&nbsp;		Action actionRemoveImage = new Action(&quot;Delete image(s)&quot;, e -&gt; {</b>
<b class="nc"><i>274</i>&nbsp;			Collection&lt;ProjectImageEntry&lt;BufferedImage&gt;&gt; entries = getAllSelectedEntries();</b>
<i>275</i>&nbsp;			
<b class="nc"><i>276</i>&nbsp;			if (entries.isEmpty())</b>
<b class="nc"><i>277</i>&nbsp;				return;</b>
<i>278</i>&nbsp;			
<i>279</i>&nbsp;			// Don&#39;t allow us to remove any entries that are currently open (in any viewer)
<b class="nc"><i>280</i>&nbsp;			var project = getProject();</b>
<b class="nc"><i>281</i>&nbsp;			if (project != null) {</b>
<b class="nc"><i>282</i>&nbsp;				for (var viewer : qupath.getViewers()) {</b>
<b class="nc"><i>283</i>&nbsp;					var imageData = viewer.getImageData();</b>
<b class="nc"><i>284</i>&nbsp;					var entry = imageData == null ? null : getProject().getEntry(imageData);</b>
<b class="nc"><i>285</i>&nbsp;					if (entry != null &amp;&amp; entries.contains(entry)) {</b>
<b class="nc"><i>286</i>&nbsp;						Dialogs.showErrorMessage(&quot;Remove project entries&quot;, &quot;Please close all images you want to remove!&quot;);</b>
<b class="nc"><i>287</i>&nbsp;						return;</b>
<i>288</i>&nbsp;					}
<b class="nc"><i>289</i>&nbsp;				}</b>
<i>290</i>&nbsp;			}
<i>291</i>&nbsp;			
<b class="nc"><i>292</i>&nbsp;			if (entries.size() == 1) {</b>
<b class="nc"><i>293</i>&nbsp;				if (!Dialogs.showConfirmDialog(&quot;Remove project entry&quot;, &quot;Remove &quot; + entries.iterator().next().getImageName() + &quot; from project?&quot;))</b>
<b class="nc"><i>294</i>&nbsp;					return;</b>
<b class="nc"><i>295</i>&nbsp;			} else if (!Dialogs.showYesNoDialog(&quot;Remove project entries&quot;, String.format(&quot;Remove %d entries?&quot;, entries.size())))</b>
<b class="nc"><i>296</i>&nbsp;				return;</b>
<i>297</i>&nbsp;			
<b class="nc"><i>298</i>&nbsp;			var result = Dialogs.showYesNoCancelDialog(&quot;Remove project entries&quot;,</b>
<i>299</i>&nbsp;					&quot;Delete all associated data?&quot;);
<b class="nc"><i>300</i>&nbsp;			if (result == DialogButton.CANCEL)</b>
<b class="nc"><i>301</i>&nbsp;				return;</b>
<i>302</i>&nbsp;			
<b class="nc"><i>303</i>&nbsp;			project.removeAllImages(entries, result == DialogButton.YES);</b>
<b class="nc"><i>304</i>&nbsp;			model.rebuildModel();</b>
<b class="nc"><i>305</i>&nbsp;			syncProject(project);</b>
<b class="nc"><i>306</i>&nbsp;			if (tree != null) {</b>
<b class="nc"><i>307</i>&nbsp;				boolean isExpanded = tree.getRoot() != null &amp;&amp; tree.getRoot().isExpanded();</b>
<b class="nc"><i>308</i>&nbsp;				tree.setRoot(model.getRootFX());</b>
<b class="nc"><i>309</i>&nbsp;				tree.getRoot().setExpanded(isExpanded);</b>
<i>310</i>&nbsp;//				tree.refresh();
<i>311</i>&nbsp;			}
<b class="nc"><i>312</i>&nbsp;		});</b>
<i>313</i>&nbsp;		
<b class="fc"><i>314</i>&nbsp;		Action actionSetImageName = new Action(&quot;Rename image&quot;, e -&gt; {</b>
<b class="nc"><i>315</i>&nbsp;			TreeItem&lt;?&gt; path = tree.getSelectionModel().getSelectedItem();</b>
<b class="nc"><i>316</i>&nbsp;			if (path == null)</b>
<b class="nc"><i>317</i>&nbsp;				return;</b>
<b class="nc"><i>318</i>&nbsp;			if (path.getValue() instanceof ProjectImageEntry) {</b>
<b class="nc"><i>319</i>&nbsp;				if (setProjectEntryImageName((ProjectImageEntry&lt;BufferedImage&gt;)path.getValue()) &amp;&amp; project != null)</b>
<b class="nc"><i>320</i>&nbsp;					syncProject(project);</b>
<i>321</i>&nbsp;			}
<b class="nc"><i>322</i>&nbsp;		});</b>
<i>323</i>&nbsp;		
<i>324</i>&nbsp;		// Refresh thumbnail according to current display settings
<b class="fc"><i>325</i>&nbsp;		Action actionRefreshThumbnail = new Action(&quot;Refresh thumbnail&quot;, e -&gt; {</b>
<b class="nc"><i>326</i>&nbsp;			TreeItem&lt;?&gt; path = tree.getSelectionModel().getSelectedItem();</b>
<b class="nc"><i>327</i>&nbsp;			if (path == null)</b>
<b class="nc"><i>328</i>&nbsp;				return;</b>
<b class="nc"><i>329</i>&nbsp;			if (path.getValue() instanceof ProjectImageEntry) {</b>
<b class="nc"><i>330</i>&nbsp;				ProjectImageEntry&lt;BufferedImage&gt; entry = (ProjectImageEntry&lt;BufferedImage&gt;)path.getValue();</b>
<b class="nc"><i>331</i>&nbsp;				if (!isCurrentImage(entry)) {</b>
<b class="nc"><i>332</i>&nbsp;					logger.warn(&quot;Cannot refresh entry for image that is not open!&quot;);</b>
<b class="nc"><i>333</i>&nbsp;					return;</b>
<i>334</i>&nbsp;				}
<b class="nc"><i>335</i>&nbsp;				BufferedImage imgThumbnail = qupath.getViewer().getRGBThumbnail();</b>
<b class="nc"><i>336</i>&nbsp;				imgThumbnail = resizeForThumbnail(imgThumbnail);</b>
<i>337</i>&nbsp;				try {
<b class="nc"><i>338</i>&nbsp;					entry.setThumbnail(imgThumbnail);</b>
<b class="nc"><i>339</i>&nbsp;				} catch (IOException e1) {</b>
<b class="nc"><i>340</i>&nbsp;					logger.error(&quot;Error writing thumbnail&quot;, e1);</b>
<b class="nc"><i>341</i>&nbsp;				}</b>
<b class="nc"><i>342</i>&nbsp;				tree.refresh();</b>
<i>343</i>&nbsp;			}
<b class="nc"><i>344</i>&nbsp;		});</b>
<i>345</i>&nbsp;		
<i>346</i>&nbsp;		// Edit the description for the image
<b class="fc"><i>347</i>&nbsp;		Action actionEditDescription = new Action(&quot;Edit description&quot;, e -&gt; {</b>
<b class="nc"><i>348</i>&nbsp;			Project&lt;?&gt; project = getProject();</b>
<b class="nc"><i>349</i>&nbsp;			ProjectImageEntry&lt;?&gt; entry = getSelectedEntry();</b>
<b class="nc"><i>350</i>&nbsp;			if (project != null &amp;&amp; entry != null) {</b>
<b class="nc"><i>351</i>&nbsp;				if (showDescriptionEditor(entry)) {</b>
<b class="nc"><i>352</i>&nbsp;					descriptionText.set(entry.getDescription());</b>
<b class="nc"><i>353</i>&nbsp;					syncProject(project);						</b>
<i>354</i>&nbsp;				}
<i>355</i>&nbsp;			} else {
<b class="nc"><i>356</i>&nbsp;				Dialogs.showErrorMessage(&quot;Edit image description&quot;, &quot;No entry is selected!&quot;);</b>
<i>357</i>&nbsp;			}
<b class="nc"><i>358</i>&nbsp;		});</b>
<i>359</i>&nbsp;		
<i>360</i>&nbsp;		// Add a metadata value
<b class="fc"><i>361</i>&nbsp;		Action actionAddMetadataValue = new Action(&quot;Add metadata&quot;, e -&gt; {</b>
<b class="nc"><i>362</i>&nbsp;			Project&lt;BufferedImage&gt; project = getProject();</b>
<b class="nc"><i>363</i>&nbsp;			Collection&lt;ProjectImageEntry&lt;BufferedImage&gt;&gt; entries = getAllSelectedEntries();</b>
<b class="nc"><i>364</i>&nbsp;			if (project != null &amp;&amp; !entries.isEmpty()) {</b>
<i>365</i>&nbsp;				
<b class="nc"><i>366</i>&nbsp;				TextField tfMetadataKey = new TextField();</b>
<b class="nc"><i>367</i>&nbsp;				var suggestions = project.getImageList().stream()</b>
<b class="nc"><i>368</i>&nbsp;						.map(p -&gt; p.getMetadataKeys())</b>
<b class="nc"><i>369</i>&nbsp;						.flatMap(Collection::stream)</b>
<b class="nc"><i>370</i>&nbsp;						.distinct()</b>
<b class="nc"><i>371</i>&nbsp;						.sorted()</b>
<b class="nc"><i>372</i>&nbsp;						.collect(Collectors.toList());</b>
<b class="nc"><i>373</i>&nbsp;				TextFields.bindAutoCompletion(tfMetadataKey, suggestions);</b>
<i>374</i>&nbsp;				
<b class="nc"><i>375</i>&nbsp;				TextField tfMetadataValue = new TextField();</b>
<b class="nc"><i>376</i>&nbsp;				Label labKey = new Label(&quot;New key&quot;);</b>
<b class="nc"><i>377</i>&nbsp;				Label labValue = new Label(&quot;New value&quot;);</b>
<b class="nc"><i>378</i>&nbsp;				labKey.setLabelFor(tfMetadataKey);</b>
<b class="nc"><i>379</i>&nbsp;				labValue.setLabelFor(tfMetadataValue);</b>
<b class="nc"><i>380</i>&nbsp;				tfMetadataKey.setTooltip(new Tooltip(&quot;Enter the name for the metadata entry&quot;));</b>
<b class="nc"><i>381</i>&nbsp;				tfMetadataValue.setTooltip(new Tooltip(&quot;Enter the value for the metadata entry&quot;));</b>
<i>382</i>&nbsp;				
<b class="nc"><i>383</i>&nbsp;				ProjectImageEntry&lt;BufferedImage&gt; entry = entries.size() == 1 ? entries.iterator().next() : null;</b>
<b class="nc"><i>384</i>&nbsp;				int nMetadataValues = entry == null ? 0 : entry.getMetadataKeys().size();</b>
<i>385</i>&nbsp;				
<b class="nc"><i>386</i>&nbsp;				GridPane pane = new GridPane();</b>
<b class="nc"><i>387</i>&nbsp;				pane.setVgap(5);</b>
<b class="nc"><i>388</i>&nbsp;				pane.setHgap(5);</b>
<b class="nc"><i>389</i>&nbsp;				pane.add(labKey, 0, 0);</b>
<b class="nc"><i>390</i>&nbsp;				pane.add(tfMetadataKey, 1, 0);</b>
<b class="nc"><i>391</i>&nbsp;				pane.add(labValue, 0, 1);</b>
<b class="nc"><i>392</i>&nbsp;				pane.add(tfMetadataValue, 1, 1);</b>
<b class="nc"><i>393</i>&nbsp;				String name = entries.size() + &quot; images&quot;;</b>
<b class="nc"><i>394</i>&nbsp;				if (entry != null) {</b>
<b class="nc"><i>395</i>&nbsp;					name = entry.getImageName();</b>
<b class="nc"><i>396</i>&nbsp;					if (nMetadataValues &gt; 0) {</b>
<i>397</i>&nbsp;						
<b class="nc"><i>398</i>&nbsp;						Label labelCurrent = new Label(&quot;Current metadata&quot;);</b>
<b class="nc"><i>399</i>&nbsp;						TextArea textAreaCurrent = new TextArea();</b>
<b class="nc"><i>400</i>&nbsp;						textAreaCurrent.setEditable(false);</b>
<i>401</i>&nbsp;	
<b class="nc"><i>402</i>&nbsp;						String keyString = entry.getMetadataSummaryString();</b>
<b class="nc"><i>403</i>&nbsp;						if (keyString.isEmpty())</b>
<b class="nc"><i>404</i>&nbsp;							textAreaCurrent.setText(&quot;No metadata entries yet&quot;);</b>
<i>405</i>&nbsp;						else
<b class="nc"><i>406</i>&nbsp;							textAreaCurrent.setText(keyString);</b>
<b class="nc"><i>407</i>&nbsp;						textAreaCurrent.setPrefRowCount(3);</b>
<b class="nc"><i>408</i>&nbsp;						labelCurrent.setLabelFor(textAreaCurrent);</b>
<i>409</i>&nbsp;	
<b class="nc"><i>410</i>&nbsp;						pane.add(labelCurrent, 0, 2);</b>
<b class="nc"><i>411</i>&nbsp;						pane.add(textAreaCurrent, 1, 2);	</b>
<i>412</i>&nbsp;					}
<i>413</i>&nbsp;				}
<i>414</i>&nbsp;				
<b class="nc"><i>415</i>&nbsp;				Dialog&lt;ButtonType&gt; dialog = new Dialog&lt;&gt;();</b>
<b class="nc"><i>416</i>&nbsp;				dialog.setTitle(&quot;Metadata&quot;);</b>
<b class="nc"><i>417</i>&nbsp;				dialog.getDialogPane().getButtonTypes().setAll(ButtonType.OK, ButtonType.CANCEL);</b>
<b class="nc"><i>418</i>&nbsp;				dialog.getDialogPane().setHeaderText(&quot;Set metadata for &quot; + name);</b>
<b class="nc"><i>419</i>&nbsp;				dialog.getDialogPane().setContent(pane);</b>
<b class="nc"><i>420</i>&nbsp;				Optional&lt;ButtonType&gt; result = dialog.showAndWait();</b>
<b class="nc"><i>421</i>&nbsp;				if (result.isPresent() &amp;&amp; result.get() == ButtonType.OK) {</b>
<b class="nc"><i>422</i>&nbsp;					String key = tfMetadataKey.getText().trim();</b>
<b class="nc"><i>423</i>&nbsp;					String value = tfMetadataValue.getText();</b>
<b class="nc"><i>424</i>&nbsp;					if (key.isEmpty()) {</b>
<b class="nc"><i>425</i>&nbsp;						logger.warn(&quot;Attempted to set metadata value for {}, but key was empty!&quot;, name);</b>
<i>426</i>&nbsp;					} else {
<i>427</i>&nbsp;						// Set metadata for all entries
<b class="nc"><i>428</i>&nbsp;						for (var temp : entries)</b>
<b class="nc"><i>429</i>&nbsp;							temp.putMetadataValue(key, value);</b>
<b class="nc"><i>430</i>&nbsp;						syncProject(project);</b>
<b class="nc"><i>431</i>&nbsp;						tree.refresh();</b>
<i>432</i>&nbsp;					}
<i>433</i>&nbsp;				}
<i>434</i>&nbsp;							
<b class="nc"><i>435</i>&nbsp;			} else {</b>
<b class="nc"><i>436</i>&nbsp;				Dialogs.showErrorMessage(&quot;Edit image description&quot;, &quot;No entry is selected!&quot;);</b>
<i>437</i>&nbsp;			}
<b class="nc"><i>438</i>&nbsp;		});</b>
<i>439</i>&nbsp;		
<b class="fc"><i>440</i>&nbsp;		Action actionDuplicateImages = new Action(&quot;Duplicate image(s)&quot;, e -&gt; {</b>
<b class="nc"><i>441</i>&nbsp;			Collection&lt;ProjectImageEntry&lt;BufferedImage&gt;&gt; entries = getAllSelectedEntries();</b>
<b class="nc"><i>442</i>&nbsp;			if (entries.isEmpty()) {</b>
<b class="nc"><i>443</i>&nbsp;				logger.debug(&quot;Cannot duplicate project entries - no entries selected&quot;);</b>
<b class="nc"><i>444</i>&nbsp;				return;</b>
<i>445</i>&nbsp;			}
<i>446</i>&nbsp;			
<b class="nc"><i>447</i>&nbsp;			boolean singleImage = false;</b>
<b class="nc"><i>448</i>&nbsp;			String name = &quot;&quot;;</b>
<b class="nc"><i>449</i>&nbsp;			String title = &quot;Duplicate images&quot;;</b>
<b class="nc"><i>450</i>&nbsp;			String namePrompt = &quot;Append to image name&quot;;</b>
<b class="nc"><i>451</i>&nbsp;			String nameHelp = &quot;Specify text to append to the image name to distinguish duplicated images&quot;;</b>
<b class="nc"><i>452</i>&nbsp;			if (entries.size() == 1) {</b>
<b class="nc"><i>453</i>&nbsp;				title = &quot;Duplicate image&quot;;</b>
<b class="nc"><i>454</i>&nbsp;				namePrompt = &quot;Duplicate image name&quot;;</b>
<b class="nc"><i>455</i>&nbsp;				nameHelp = &quot;Specify name for the duplicated image&quot;;</b>
<b class="nc"><i>456</i>&nbsp;				singleImage = true;</b>
<b class="nc"><i>457</i>&nbsp;				name = entries.iterator().next().getImageName();</b>
<b class="nc"><i>458</i>&nbsp;				name = GeneralTools.generateDistinctName(</b>
<i>459</i>&nbsp;						name,
<b class="nc"><i>460</i>&nbsp;						project.getImageList().stream().map(p -&gt; p.getImageName()).collect(Collectors.toSet()));</b>
<i>461</i>&nbsp;			}
<b class="nc"><i>462</i>&nbsp;			var params = new ParameterList()</b>
<b class="nc"><i>463</i>&nbsp;					.addStringParameter(&quot;name&quot;, namePrompt, name, nameHelp)</b>
<b class="nc"><i>464</i>&nbsp;					.addBooleanParameter(&quot;copyData&quot;, &quot;Also duplicate data files&quot;, true, &quot;Duplicate any associated data files along with the image&quot;);</b>
<i>465</i>&nbsp;			
<b class="nc"><i>466</i>&nbsp;			if (!Dialogs.showParameterDialog(title, params))</b>
<b class="nc"><i>467</i>&nbsp;				return;</b>
<i>468</i>&nbsp;
<b class="nc"><i>469</i>&nbsp;			boolean copyData = params.getBooleanParameterValue(&quot;copyData&quot;);</b>
<b class="nc"><i>470</i>&nbsp;			name = params.getStringParameterValue(&quot;name&quot;);</b>
<i>471</i>&nbsp;
<i>472</i>&nbsp;			// Ensure we have a single space and then the text to append, with extra whitespace removed
<b class="nc"><i>473</i>&nbsp;			if (!singleImage &amp;&amp; !name.isBlank())</b>
<b class="nc"><i>474</i>&nbsp;				name = &quot; &quot; + name.strip();</b>
<i>475</i>&nbsp;			
<b class="nc"><i>476</i>&nbsp;			for (var entry : entries) {</b>
<i>477</i>&nbsp;				try {
<b class="nc"><i>478</i>&nbsp;					var newEntry = project.addDuplicate(entry, copyData);</b>
<b class="nc"><i>479</i>&nbsp;					if (newEntry != null &amp;&amp; !name.isBlank()) {</b>
<b class="nc"><i>480</i>&nbsp;						if (singleImage)</b>
<b class="nc"><i>481</i>&nbsp;							newEntry.setImageName(name);</b>
<i>482</i>&nbsp;						else
<b class="nc"><i>483</i>&nbsp;							newEntry.setImageName(newEntry.getImageName() + name);</b>
<i>484</i>&nbsp;					}
<b class="nc"><i>485</i>&nbsp;				} catch (Exception ex) {</b>
<b class="nc"><i>486</i>&nbsp;					Dialogs.showErrorNotification(&quot;Duplicating image&quot;, &quot;Error duplicating &quot; + entry.getImageName());</b>
<b class="nc"><i>487</i>&nbsp;					logger.error(ex.getLocalizedMessage(), ex);</b>
<b class="nc"><i>488</i>&nbsp;				}</b>
<b class="nc"><i>489</i>&nbsp;			}</b>
<i>490</i>&nbsp;			try {
<b class="nc"><i>491</i>&nbsp;				project.syncChanges();</b>
<b class="nc"><i>492</i>&nbsp;			} catch (Exception ex) {</b>
<b class="nc"><i>493</i>&nbsp;				logger.error(&quot;Error synchronizing project changes: &quot; + ex.getLocalizedMessage(), ex);</b>
<b class="nc"><i>494</i>&nbsp;			}</b>
<b class="nc"><i>495</i>&nbsp;			refreshProject();</b>
<b class="nc"><i>496</i>&nbsp;			if (entries.size() == 1)</b>
<b class="nc"><i>497</i>&nbsp;				logger.debug(&quot;Duplicated 1 image entry&quot;);</b>
<i>498</i>&nbsp;			else
<b class="nc"><i>499</i>&nbsp;				logger.debug(&quot;Duplicated {} image entries&quot;);</b>
<b class="nc"><i>500</i>&nbsp;		});</b>
<i>501</i>&nbsp;		
<i>502</i>&nbsp;		// Open the project directory using Explorer/Finder etc.
<b class="fc"><i>503</i>&nbsp;		Action actionOpenProjectDirectory = createBrowsePathAction(&quot;Project...&quot;, () -&gt; getProjectPath());</b>
<b class="fc"><i>504</i>&nbsp;		Action actionOpenProjectEntryDirectory = createBrowsePathAction(&quot;Project entry...&quot;, () -&gt; getProjectEntryPath());</b>
<b class="fc"><i>505</i>&nbsp;		Action actionOpenImageServerDirectory = createBrowsePathAction(&quot;Image server...&quot;, () -&gt; getImageServerPath());</b>
<i>506</i>&nbsp;		
<i>507</i>&nbsp;
<b class="fc"><i>508</i>&nbsp;		Menu menuSort = new Menu(&quot;Sort by...&quot;);</b>
<b class="fc"><i>509</i>&nbsp;		ContextMenu menu = new ContextMenu();</b>
<i>510</i>&nbsp;		
<b class="fc"><i>511</i>&nbsp;		var hasProjectBinding = qupath.projectProperty().isNotNull();</b>
<b class="fc"><i>512</i>&nbsp;		var menuOpenDirectories = MenuTools.createMenu(&quot;Open directory...&quot;, </b>
<i>513</i>&nbsp;				actionOpenProjectDirectory,
<i>514</i>&nbsp;				actionOpenProjectEntryDirectory,
<i>515</i>&nbsp;				actionOpenImageServerDirectory);
<b class="fc"><i>516</i>&nbsp;		menuOpenDirectories.visibleProperty().bind(hasProjectBinding);</b>
<i>517</i>&nbsp;//		MenuItem miOpenProjectDirectory = ActionUtils.createMenuItem(actionOpenProjectDirectory);
<i>518</i>&nbsp;		
<i>519</i>&nbsp;		
<b class="fc"><i>520</i>&nbsp;		MenuItem miOpenImage = ActionUtils.createMenuItem(actionOpenImage);</b>
<b class="fc"><i>521</i>&nbsp;		MenuItem miRemoveImage = ActionUtils.createMenuItem(actionRemoveImage);</b>
<b class="fc"><i>522</i>&nbsp;		MenuItem miDuplicateImage = ActionUtils.createMenuItem(actionDuplicateImages);</b>
<b class="fc"><i>523</i>&nbsp;		MenuItem miSetImageName = ActionUtils.createMenuItem(actionSetImageName);</b>
<b class="fc"><i>524</i>&nbsp;		MenuItem miRefreshThumbnail = ActionUtils.createMenuItem(actionRefreshThumbnail);</b>
<b class="fc"><i>525</i>&nbsp;		MenuItem miEditDescription = ActionUtils.createMenuItem(actionEditDescription);</b>
<b class="fc"><i>526</i>&nbsp;		MenuItem miAddMetadata = ActionUtils.createMenuItem(actionAddMetadataValue);</b>
<i>527</i>&nbsp;		
<i>528</i>&nbsp;		
<i>529</i>&nbsp;		// Set visibility as menu being displayed
<b class="fc"><i>530</i>&nbsp;		menu.setOnShowing(e -&gt; {</b>
<b class="nc"><i>531</i>&nbsp;			TreeItem&lt;Object&gt; selected = tree.getSelectionModel().getSelectedItem();</b>
<b class="nc"><i>532</i>&nbsp;			var entries = getAllSelectedEntries();</b>
<b class="nc"><i>533</i>&nbsp;			boolean hasImageEntry = selected != null &amp;&amp; selected.getValue() instanceof ProjectImageEntry;</b>
<i>534</i>&nbsp;//			miOpenProjectDirectory.setVisible(project != null &amp;&amp; project.getBaseDirectory().exists());
<b class="nc"><i>535</i>&nbsp;			miOpenImage.setVisible(hasImageEntry);</b>
<b class="nc"><i>536</i>&nbsp;			miSetImageName.setVisible(hasImageEntry);</b>
<b class="nc"><i>537</i>&nbsp;			miAddMetadata.setVisible(!entries.isEmpty());</b>
<b class="nc"><i>538</i>&nbsp;			miEditDescription.setVisible(hasImageEntry);</b>
<b class="nc"><i>539</i>&nbsp;			miRefreshThumbnail.setVisible(hasImageEntry &amp;&amp; isCurrentImage((ProjectImageEntry&lt;BufferedImage&gt;)selected.getValue()));</b>
<b class="nc"><i>540</i>&nbsp;			miRemoveImage.setVisible(project != null &amp;&amp; !project.getImageList().isEmpty());</b>
<i>541</i>&nbsp;			
<b class="nc"><i>542</i>&nbsp;			if (project == null) {</b>
<b class="nc"><i>543</i>&nbsp;				menuSort.setVisible(false);</b>
<b class="nc"><i>544</i>&nbsp;				return;</b>
<i>545</i>&nbsp;			}
<b class="nc"><i>546</i>&nbsp;			Map&lt;String, MenuItem&gt; newItems = new TreeMap&lt;&gt;();</b>
<b class="nc"><i>547</i>&nbsp;			for (ProjectImageEntry&lt;?&gt; entry : project.getImageList()) {</b>
<i>548</i>&nbsp;				// Add all entry metadata keys
<b class="nc"><i>549</i>&nbsp;				for (String key : entry.getMetadataKeys()) {</b>
<b class="nc"><i>550</i>&nbsp;					if (!newItems.containsKey(key))</b>
<b class="nc"><i>551</i>&nbsp;						newItems.put(key, ActionUtils.createMenuItem(createSortByKeyAction(key, key)));</b>
<b class="nc"><i>552</i>&nbsp;				}</b>
<i>553</i>&nbsp;				// Add all additional keys
<b class="nc"><i>554</i>&nbsp;				for (String key : additionalSortKeys) {</b>
<b class="nc"><i>555</i>&nbsp;					if (!newItems.containsKey(key))</b>
<b class="nc"><i>556</i>&nbsp;						newItems.put(key, ActionUtils.createMenuItem(createSortByKeyAction(key, key)));</b>
<i>557</i>&nbsp;				}
<b class="nc"><i>558</i>&nbsp;			}</b>
<b class="nc"><i>559</i>&nbsp;			menuSort.getItems().setAll(newItems.values());</b>
<i>560</i>&nbsp;			
<b class="nc"><i>561</i>&nbsp;			menuSort.getItems().add(0, ActionUtils.createMenuItem(createSortByKeyAction(&quot;None&quot;, null)));</b>
<b class="nc"><i>562</i>&nbsp;			menuSort.getItems().add(1, new SeparatorMenuItem());</b>
<i>563</i>&nbsp;			
<b class="nc"><i>564</i>&nbsp;			menuSort.setVisible(true);</b>
<i>565</i>&nbsp;			
<b class="nc"><i>566</i>&nbsp;			if (menu.getItems().isEmpty())</b>
<b class="nc"><i>567</i>&nbsp;				e.consume();</b>
<b class="nc"><i>568</i>&nbsp;		});</b>
<i>569</i>&nbsp;		
<b class="fc"><i>570</i>&nbsp;		SeparatorMenuItem separator = new SeparatorMenuItem();</b>
<b class="fc"><i>571</i>&nbsp;		separator.visibleProperty().bind(menuSort.visibleProperty());</b>
<b class="fc"><i>572</i>&nbsp;		menu.getItems().addAll(</b>
<i>573</i>&nbsp;				miOpenImage,
<i>574</i>&nbsp;				miRemoveImage,
<i>575</i>&nbsp;				miDuplicateImage,
<i>576</i>&nbsp;				new SeparatorMenuItem(),
<i>577</i>&nbsp;				miSetImageName,
<i>578</i>&nbsp;				miAddMetadata,
<i>579</i>&nbsp;				miEditDescription,
<i>580</i>&nbsp;				miRefreshThumbnail,
<i>581</i>&nbsp;				separator,
<i>582</i>&nbsp;				menuSort
<i>583</i>&nbsp;				);
<i>584</i>&nbsp;		
<b class="fc"><i>585</i>&nbsp;		separator = new SeparatorMenuItem();</b>
<b class="fc"><i>586</i>&nbsp;		separator.visibleProperty().bind(menuOpenDirectories.visibleProperty());</b>
<b class="fc"><i>587</i>&nbsp;		if (Desktop.isDesktopSupported()) {</b>
<b class="fc"><i>588</i>&nbsp;			menu.getItems().addAll(</b>
<i>589</i>&nbsp;					separator,
<i>590</i>&nbsp;					menuOpenDirectories);
<i>591</i>&nbsp;		}
<i>592</i>&nbsp;
<b class="fc"><i>593</i>&nbsp;		return menu;</b>
<i>594</i>&nbsp;
<i>595</i>&nbsp;	}
<i>596</i>&nbsp;	
<i>597</i>&nbsp;	Path getProjectPath() {
<b class="fc"><i>598</i>&nbsp;		return project == null ? null : project.getPath();</b>
<i>599</i>&nbsp;	}
<i>600</i>&nbsp;
<i>601</i>&nbsp;	Path getProjectEntryPath() {
<b class="fc"><i>602</i>&nbsp;		var selected = tree.getSelectionModel().getSelectedItem();</b>
<b class="fc"><i>603</i>&nbsp;		if (selected == null)</b>
<b class="fc"><i>604</i>&nbsp;			return null;</b>
<b class="nc"><i>605</i>&nbsp;		var item = selected.getValue();</b>
<b class="nc"><i>606</i>&nbsp;		if (item instanceof ProjectImageEntry&lt;?&gt;)</b>
<b class="nc"><i>607</i>&nbsp;			return ((ProjectImageEntry&lt;?&gt;)item).getEntryPath();</b>
<b class="nc"><i>608</i>&nbsp;		return null;</b>
<i>609</i>&nbsp;	}
<i>610</i>&nbsp;	
<i>611</i>&nbsp;	Path getImageServerPath() {
<b class="fc"><i>612</i>&nbsp;		var selected = tree.getSelectionModel().getSelectedItem();</b>
<b class="fc"><i>613</i>&nbsp;		if (selected == null)</b>
<b class="fc"><i>614</i>&nbsp;			return null;</b>
<b class="nc"><i>615</i>&nbsp;		var item = selected.getValue();</b>
<b class="nc"><i>616</i>&nbsp;		if (item instanceof ProjectImageEntry&lt;?&gt;) {</b>
<i>617</i>&nbsp;			try {
<b class="nc"><i>618</i>&nbsp;				var uris = ((ProjectImageEntry&lt;?&gt;)item).getServerURIs();</b>
<b class="nc"><i>619</i>&nbsp;				if (!uris.isEmpty())</b>
<b class="nc"><i>620</i>&nbsp;					return GeneralTools.toPath(uris.iterator().next());</b>
<b class="nc"><i>621</i>&nbsp;			} catch (IOException e) {</b>
<b class="nc"><i>622</i>&nbsp;				logger.debug(&quot;Error converting server path to file path&quot;, e);</b>
<b class="nc"><i>623</i>&nbsp;			}</b>
<i>624</i>&nbsp;		}
<b class="nc"><i>625</i>&nbsp;		return null;</b>
<i>626</i>&nbsp;	}
<i>627</i>&nbsp;
<i>628</i>&nbsp;	
<i>629</i>&nbsp;	Action createBrowsePathAction(String text, Supplier&lt;Path&gt; func) {
<b class="fc"><i>630</i>&nbsp;		var action = new Action(text, e -&gt; {</b>
<b class="nc"><i>631</i>&nbsp;			var path = func.get();</b>
<b class="nc"><i>632</i>&nbsp;			if (path == null)</b>
<b class="nc"><i>633</i>&nbsp;				return;</b>
<i>634</i>&nbsp;			// Get directory if we will need one
<b class="nc"><i>635</i>&nbsp;			GuiTools.browseDirectory(path.toFile());</b>
<b class="nc"><i>636</i>&nbsp;		});</b>
<b class="fc"><i>637</i>&nbsp;		action.disabledProperty().bind(Bindings.createBooleanBinding(() -&gt; func.get() == null, tree.getSelectionModel().selectedItemProperty()));</b>
<b class="fc"><i>638</i>&nbsp;		return action;</b>
<i>639</i>&nbsp;	}
<i>640</i>&nbsp;	
<i>641</i>&nbsp;	
<i>642</i>&nbsp;	
<i>643</i>&nbsp;	/**
<i>644</i>&nbsp;	 * Try to save a project, showing an error message if this fails.
<i>645</i>&nbsp;	 * 
<i>646</i>&nbsp;	 * @param project
<i>647</i>&nbsp;	 * @return
<i>648</i>&nbsp;	 */
<i>649</i>&nbsp;	public static boolean syncProject(Project&lt;?&gt; project) {
<i>650</i>&nbsp;		try {
<b class="nc"><i>651</i>&nbsp;			logger.info(&quot;Saving project {}...&quot;, project);</b>
<b class="nc"><i>652</i>&nbsp;			project.syncChanges();</b>
<b class="nc"><i>653</i>&nbsp;			return true;</b>
<b class="nc"><i>654</i>&nbsp;		} catch (IOException e) {</b>
<b class="nc"><i>655</i>&nbsp;			Dialogs.showErrorMessage(&quot;Save project&quot;, e);</b>
<b class="nc"><i>656</i>&nbsp;			return false;</b>
<i>657</i>&nbsp;		}
<i>658</i>&nbsp;	}
<i>659</i>&nbsp;	
<i>660</i>&nbsp;	
<i>661</i>&nbsp;	boolean showDescriptionEditor(ProjectImageEntry&lt;?&gt; entry) {
<b class="nc"><i>662</i>&nbsp;		TextArea editor = new TextArea();</b>
<b class="nc"><i>663</i>&nbsp;		editor.setWrapText(true);</b>
<b class="nc"><i>664</i>&nbsp;		editor.setText(entry.getDescription());</b>
<b class="nc"><i>665</i>&nbsp;		Dialog&lt;ButtonType&gt; dialog = new Dialog&lt;&gt;();</b>
<b class="nc"><i>666</i>&nbsp;		dialog.getDialogPane().getButtonTypes().setAll(ButtonType.OK, ButtonType.CANCEL);</b>
<b class="nc"><i>667</i>&nbsp;		dialog.setTitle(&quot;Image description&quot;);</b>
<b class="nc"><i>668</i>&nbsp;		dialog.getDialogPane().setHeaderText(entry.getImageName());</b>
<b class="nc"><i>669</i>&nbsp;		dialog.getDialogPane().setContent(editor);</b>
<b class="nc"><i>670</i>&nbsp;		Optional&lt;ButtonType&gt; result = dialog.showAndWait();</b>
<b class="nc"><i>671</i>&nbsp;		if (result.isPresent() &amp;&amp; result.get() == ButtonType.OK &amp;&amp; editor.getText() != null) {	</b>
<b class="nc"><i>672</i>&nbsp;			var text = editor.getText();</b>
<b class="nc"><i>673</i>&nbsp;			entry.setDescription(text.isEmpty() ? null : text);</b>
<b class="nc"><i>674</i>&nbsp;			return true;</b>
<i>675</i>&nbsp;		}
<b class="nc"><i>676</i>&nbsp;		return false;</b>
<i>677</i>&nbsp;	}
<i>678</i>&nbsp;
<i>679</i>&nbsp;
<i>680</i>&nbsp;	private Project&lt;BufferedImage&gt; getProject() {
<b class="nc"><i>681</i>&nbsp;		return project;</b>
<i>682</i>&nbsp;	}
<i>683</i>&nbsp;
<i>684</i>&nbsp;	/**
<i>685</i>&nbsp;	 * Get the {@link Pane} component for addition to a scene.
<i>686</i>&nbsp;	 * @return
<i>687</i>&nbsp;	 */
<i>688</i>&nbsp;	public Pane getPane() {
<b class="fc"><i>689</i>&nbsp;		return panel;</b>
<i>690</i>&nbsp;	}
<i>691</i>&nbsp;
<i>692</i>&nbsp;
<i>693</i>&nbsp;	/**
<i>694</i>&nbsp;	 * Set the project.
<i>695</i>&nbsp;	 * @param project
<i>696</i>&nbsp;	 * @return true if the project is now set (even if unchanged), false if the project change was thwarted or canceled.
<i>697</i>&nbsp;	 */
<i>698</i>&nbsp;	public boolean setProject(final Project&lt;BufferedImage&gt; project) {
<b class="nc"><i>699</i>&nbsp;		if (this.project == project)</b>
<b class="nc"><i>700</i>&nbsp;			return true;		</b>
<i>701</i>&nbsp;		
<b class="nc"><i>702</i>&nbsp;		this.project = project;</b>
<i>703</i>&nbsp;
<b class="nc"><i>704</i>&nbsp;		model = new ProjectImageTreeModel(project);</b>
<b class="nc"><i>705</i>&nbsp;		tree.setRoot(model.getRootFX());</b>
<b class="nc"><i>706</i>&nbsp;		tree.getRoot().setExpanded(true);</b>
<b class="nc"><i>707</i>&nbsp;		return true;</b>
<i>708</i>&nbsp;	}
<i>709</i>&nbsp;	
<i>710</i>&nbsp;	
<i>711</i>&nbsp;	/**
<i>712</i>&nbsp;	 * Refresh the current project, updating the displayed entries.
<i>713</i>&nbsp;	 * Note that this must be called on the JavaFX Application thread.
<i>714</i>&nbsp;	 * If it is not, the request will be passed to the application thread 
<i>715</i>&nbsp;	 * (and therefore not processed immediately).
<i>716</i>&nbsp;	 */
<i>717</i>&nbsp;	public void refreshProject() {
<b class="nc"><i>718</i>&nbsp;		if (!Platform.isFxApplicationThread()) {</b>
<b class="nc"><i>719</i>&nbsp;			Platform.runLater(() -&gt; refreshProject());</b>
<b class="nc"><i>720</i>&nbsp;			return;</b>
<i>721</i>&nbsp;		}
<b class="nc"><i>722</i>&nbsp;		model = new ProjectImageTreeModel(project);</b>
<b class="nc"><i>723</i>&nbsp;		tree.setRoot(model.getRootFX());</b>
<b class="nc"><i>724</i>&nbsp;		tree.getRoot().setExpanded(true);		</b>
<b class="nc"><i>725</i>&nbsp;	}</b>
<i>726</i>&nbsp;
<i>727</i>&nbsp;
<i>728</i>&nbsp;	void ensureServerInWorkspace(final ImageData&lt;BufferedImage&gt; imageData) {
<b class="nc"><i>729</i>&nbsp;		if (imageData == null || project == null)</b>
<b class="nc"><i>730</i>&nbsp;			return;</b>
<i>731</i>&nbsp;		
<b class="nc"><i>732</i>&nbsp;		if (project.getEntry(imageData) != null)</b>
<b class="nc"><i>733</i>&nbsp;			return;</b>
<i>734</i>&nbsp;
<b class="nc"><i>735</i>&nbsp;		var entry = ProjectCommands.addSingleImageToProject(project, imageData.getServer(), null);</b>
<b class="nc"><i>736</i>&nbsp;		if (entry != null) {</b>
<b class="nc"><i>737</i>&nbsp;			boolean expanded = tree.getRoot() != null &amp;&amp; tree.getRoot().isExpanded();</b>
<b class="nc"><i>738</i>&nbsp;			tree.setRoot(model.getRootFX());</b>
<b class="nc"><i>739</i>&nbsp;			setSelectedEntry(tree, tree.getRoot(), project.getEntry(imageData));</b>
<b class="nc"><i>740</i>&nbsp;			syncProject(project);</b>
<b class="nc"><i>741</i>&nbsp;			if (expanded)</b>
<b class="nc"><i>742</i>&nbsp;				tree.getRoot().setExpanded(true);</b>
<i>743</i>&nbsp;			// Copy the ImageData to the current entry
<b class="nc"><i>744</i>&nbsp;			if (!entry.hasImageData()) {</b>
<i>745</i>&nbsp;				try {
<b class="nc"><i>746</i>&nbsp;					logger.info(&quot;Copying ImageData to {}&quot;, entry);</b>
<b class="nc"><i>747</i>&nbsp;					entry.saveImageData(imageData);</b>
<b class="nc"><i>748</i>&nbsp;				} catch (IOException e) {</b>
<b class="nc"><i>749</i>&nbsp;					logger.error(&quot;Unable to save ImageData: &quot; + e.getLocalizedMessage(), e);</b>
<b class="nc"><i>750</i>&nbsp;				}</b>
<i>751</i>&nbsp;			}
<i>752</i>&nbsp;		}
<b class="nc"><i>753</i>&nbsp;	}</b>
<i>754</i>&nbsp;
<i>755</i>&nbsp;
<i>756</i>&nbsp;
<i>757</i>&nbsp;	@Override
<i>758</i>&nbsp;	public void changed(final ObservableValue&lt;? extends ImageData&lt;BufferedImage&gt;&gt; source, final ImageData&lt;BufferedImage&gt; imageDataOld, final ImageData&lt;BufferedImage&gt; imageDataNew) {
<b class="fc"><i>759</i>&nbsp;		if (imageDataNew == null || project == null)</b>
<b class="fc"><i>760</i>&nbsp;			return;</b>
<b class="nc"><i>761</i>&nbsp;		ProjectImageEntry&lt;BufferedImage&gt; entry = project.getEntry(imageDataNew);</b>
<b class="nc"><i>762</i>&nbsp;		if (entry == null) {</b>
<i>763</i>&nbsp;			// Previously we gave a choice... now we force the image to be included in the project to avoid complications
<i>764</i>&nbsp;//			if (DisplayHelpers.showYesNoDialog(&quot;Add to project&quot;, &quot;Add &quot; + imageDataNew.getServer().getShortServerName() + &quot; to project?&quot;))
<b class="nc"><i>765</i>&nbsp;				ensureServerInWorkspace(imageDataNew);</b>
<i>766</i>&nbsp;		}
<b class="nc"><i>767</i>&nbsp;		else if (!entry.equals(getSelectedEntry()))</b>
<b class="nc"><i>768</i>&nbsp;			setSelectedEntry(tree, tree.getRoot(), entry);</b>
<i>769</i>&nbsp;		//			list.setSelectedValue(entry, true);
<i>770</i>&nbsp;
<b class="nc"><i>771</i>&nbsp;		if (tree != null) {</b>
<b class="nc"><i>772</i>&nbsp;			tree.refresh();</b>
<i>773</i>&nbsp;		}
<b class="nc"><i>774</i>&nbsp;	}</b>
<i>775</i>&nbsp;
<i>776</i>&nbsp;
<i>777</i>&nbsp;
<i>778</i>&nbsp;	static &lt;T&gt; boolean setSelectedEntry(TreeView&lt;T&gt; treeView, TreeItem&lt;T&gt; item, final T object) {
<b class="nc"><i>779</i>&nbsp;		if (item.getValue() == object) {</b>
<b class="nc"><i>780</i>&nbsp;			treeView.getSelectionModel().select(item);</b>
<b class="nc"><i>781</i>&nbsp;			return true;</b>
<i>782</i>&nbsp;		} else {
<b class="nc"><i>783</i>&nbsp;			for (TreeItem&lt;T&gt; child : item.getChildren()) {</b>
<b class="nc"><i>784</i>&nbsp;				if (setSelectedEntry(treeView, child, object))</b>
<b class="nc"><i>785</i>&nbsp;					return true;</b>
<b class="nc"><i>786</i>&nbsp;			}</b>
<i>787</i>&nbsp;		}
<b class="nc"><i>788</i>&nbsp;		return false;</b>
<i>789</i>&nbsp;	}
<i>790</i>&nbsp;	
<i>791</i>&nbsp;	
<i>792</i>&nbsp;	
<i>793</i>&nbsp;	
<i>794</i>&nbsp;	Image requestThumbnail(final String serverPath, final File fileThumbnail) throws IOException {
<i>795</i>&nbsp;//		serversRequested.clear();
<i>796</i>&nbsp;		
<i>797</i>&nbsp;		// Check if we&#39;ve already asked for this server... if so, stop
<b class="nc"><i>798</i>&nbsp;		if (serversRequested.contains(serverPath))</b>
<b class="nc"><i>799</i>&nbsp;			return null;</b>
<i>800</i>&nbsp;		// Put in the request now
<b class="nc"><i>801</i>&nbsp;		serversRequested.add(serverPath);</b>
<i>802</i>&nbsp;		// Check if it exists
<b class="nc"><i>803</i>&nbsp;		if (fileThumbnail.exists())</b>
<b class="nc"><i>804</i>&nbsp;			return SwingFXUtils.toFXImage(ImageIO.read(fileThumbnail), null);</b>
<i>805</i>&nbsp;		// Try to load the server
<b class="nc"><i>806</i>&nbsp;		ImageData&lt;BufferedImage&gt; imageData = getCurrentImageData();</b>
<b class="nc"><i>807</i>&nbsp;		ImageServer&lt;BufferedImage&gt; server = null;</b>
<b class="nc"><i>808</i>&nbsp;		boolean newServer = false;</b>
<b class="nc"><i>809</i>&nbsp;		if (imageData != null &amp;&amp; imageData.getServerPath().equals(serverPath))</b>
<b class="nc"><i>810</i>&nbsp;			server = imageData.getServer();</b>
<i>811</i>&nbsp;		else {
<b class="nc"><i>812</i>&nbsp;			server = ImageServerProvider.buildServer(serverPath, BufferedImage.class);</b>
<b class="nc"><i>813</i>&nbsp;			newServer = true;</b>
<i>814</i>&nbsp;		}
<b class="nc"><i>815</i>&nbsp;		BufferedImage img2 = ProjectCommands.getThumbnailRGB(server);</b>
<b class="nc"><i>816</i>&nbsp;		if (newServer) {</b>
<i>817</i>&nbsp;			try {
<b class="nc"><i>818</i>&nbsp;				server.close();</b>
<b class="nc"><i>819</i>&nbsp;			} catch (Exception e) {</b>
<b class="nc"><i>820</i>&nbsp;				logger.warn(&quot;Problem closing server&quot;, e);</b>
<b class="nc"><i>821</i>&nbsp;			}</b>
<i>822</i>&nbsp;		}
<b class="nc"><i>823</i>&nbsp;		ImageIO.write(img2, THUMBNAIL_EXT, fileThumbnail);</b>
<b class="nc"><i>824</i>&nbsp;		return SwingFXUtils.toFXImage(img2, null);</b>
<i>825</i>&nbsp;	}
<i>826</i>&nbsp;
<i>827</i>&nbsp;	
<i>828</i>&nbsp;	/**
<i>829</i>&nbsp;	 * Resize an image so that its dimensions fit inside thumbnailWidth x thumbnailHeight.
<i>830</i>&nbsp;	 * 
<i>831</i>&nbsp;	 * Note: this assumes the image can be drawn to a Graphics object.
<i>832</i>&nbsp;	 * 
<i>833</i>&nbsp;	 * @param imgThumbnail
<i>834</i>&nbsp;	 * @return
<i>835</i>&nbsp;	 */
<i>836</i>&nbsp;	BufferedImage resizeForThumbnail(BufferedImage imgThumbnail) {
<b class="nc"><i>837</i>&nbsp;		double scale = Math.min((double)thumbnailWidth / imgThumbnail.getWidth(), (double)thumbnailHeight / imgThumbnail.getHeight());</b>
<b class="nc"><i>838</i>&nbsp;		if (scale &gt; 1)</b>
<b class="nc"><i>839</i>&nbsp;			return imgThumbnail;</b>
<b class="nc"><i>840</i>&nbsp;		BufferedImage imgThumbnail2 = new BufferedImage((int)(imgThumbnail.getWidth() * scale), (int)(imgThumbnail.getHeight() * scale), imgThumbnail.getType());</b>
<b class="nc"><i>841</i>&nbsp;		Graphics2D g2d = imgThumbnail2.createGraphics();</b>
<b class="nc"><i>842</i>&nbsp;		g2d.setRenderingHint(RenderingHints.KEY_INTERPOLATION, RenderingHints.VALUE_INTERPOLATION_BILINEAR);</b>
<b class="nc"><i>843</i>&nbsp;		g2d.drawImage(imgThumbnail, 0, 0, imgThumbnail2.getWidth(), imgThumbnail2.getHeight(), null);</b>
<b class="nc"><i>844</i>&nbsp;		g2d.dispose();</b>
<b class="nc"><i>845</i>&nbsp;		return imgThumbnail2;</b>
<i>846</i>&nbsp;	}
<i>847</i>&nbsp;
<i>848</i>&nbsp;
<i>849</i>&nbsp;	//	@Override
<i>850</i>&nbsp;	//	public void valueChanged(ListSelectionEvent e) {
<i>851</i>&nbsp;	//		updateThumbnailForSelected();
<i>852</i>&nbsp;	////		openSelectedImage();
<i>853</i>&nbsp;	////		ProjectImageEntry entry = list.getSelectedValue();
<i>854</i>&nbsp;	////		qupath.openWholeSlideServer(entry.getServerPath(), true, true);
<i>855</i>&nbsp;	//	}
<i>856</i>&nbsp;
<i>857</i>&nbsp;
<i>858</i>&nbsp;
<i>859</i>&nbsp;	//	boolean openImage(final String path) {
<i>860</i>&nbsp;	//		
<i>861</i>&nbsp;	//	}
<i>862</i>&nbsp;
<i>863</i>&nbsp;
<i>864</i>&nbsp;	ImageData&lt;BufferedImage&gt; getCurrentImageData() {
<b class="nc"><i>865</i>&nbsp;		return qupath.getViewer().getImageData();</b>
<i>866</i>&nbsp;	}
<i>867</i>&nbsp;
<i>868</i>&nbsp;
<i>869</i>&nbsp;	File getBaseDirectory() {
<b class="nc"><i>870</i>&nbsp;		return Projects.getBaseDirectory(project);</b>
<i>871</i>&nbsp;	}
<i>872</i>&nbsp;
<i>873</i>&nbsp;
<i>874</i>&nbsp;	File getProjectFile() {
<b class="nc"><i>875</i>&nbsp;		File dirBase = getBaseDirectory();</b>
<b class="nc"><i>876</i>&nbsp;		if (dirBase == null || !dirBase.isDirectory())</b>
<b class="nc"><i>877</i>&nbsp;			return null;</b>
<b class="nc"><i>878</i>&nbsp;		return new File(dirBase, &quot;project&quot; + ProjectIO.getProjectExtension());</b>
<i>879</i>&nbsp;	}
<i>880</i>&nbsp;
<i>881</i>&nbsp;
<i>882</i>&nbsp;	boolean isCurrentImage(final ProjectImageEntry&lt;BufferedImage&gt; entry) {
<b class="nc"><i>883</i>&nbsp;		ImageData&lt;BufferedImage&gt; imageData = getCurrentImageData();</b>
<b class="nc"><i>884</i>&nbsp;		if (imageData == null || entry == null || project == null)</b>
<b class="nc"><i>885</i>&nbsp;			return false;</b>
<b class="nc"><i>886</i>&nbsp;		return project.getEntry(imageData) == entry;</b>
<i>887</i>&nbsp;	}
<i>888</i>&nbsp;
<i>889</i>&nbsp;
<i>890</i>&nbsp;	Collection&lt;ProjectImageEntry&lt;BufferedImage&gt;&gt; getAllSelectedEntries() {
<b class="nc"><i>891</i>&nbsp;		List&lt;TreeItem&lt;Object&gt;&gt; selected = tree.getSelectionModel().getSelectedItems();</b>
<b class="nc"><i>892</i>&nbsp;		if (selected == null)</b>
<b class="nc"><i>893</i>&nbsp;			return Collections.emptyList();</b>
<b class="nc"><i>894</i>&nbsp;		return selected.stream().map(p -&gt; {</b>
<b class="nc"><i>895</i>&nbsp;			if (p.getValue() instanceof ProjectImageEntry)</b>
<b class="nc"><i>896</i>&nbsp;				return Collections.singletonList((ProjectImageEntry&lt;BufferedImage&gt;)p.getValue());</b>
<i>897</i>&nbsp;			else
<b class="nc"><i>898</i>&nbsp;				return getImageEntries(p, null);</b>
<b class="nc"><i>899</i>&nbsp;		}).flatMap(Collection::stream).collect(Collectors.toSet());</b>
<i>900</i>&nbsp;	}
<i>901</i>&nbsp;	
<i>902</i>&nbsp;
<i>903</i>&nbsp;	ProjectImageEntry&lt;BufferedImage&gt; getSelectedEntry() {
<b class="nc"><i>904</i>&nbsp;		TreeItem&lt;Object&gt; selected = tree.getSelectionModel().getSelectedItem();</b>
<b class="nc"><i>905</i>&nbsp;		if (selected != null &amp;&amp; selected.getValue() instanceof ProjectImageEntry)</b>
<b class="nc"><i>906</i>&nbsp;			return (ProjectImageEntry&lt;BufferedImage&gt;)selected.getValue();</b>
<b class="nc"><i>907</i>&nbsp;		return null;</b>
<i>908</i>&nbsp;	}
<i>909</i>&nbsp;
<i>910</i>&nbsp;
<i>911</i>&nbsp;	static Collection&lt;ProjectImageEntry&lt;BufferedImage&gt;&gt; getImageEntries(final TreeItem&lt;?&gt; item, Collection&lt;ProjectImageEntry&lt;BufferedImage&gt;&gt; entries) {
<b class="nc"><i>912</i>&nbsp;		if (entries == null)</b>
<b class="nc"><i>913</i>&nbsp;			entries = new HashSet&lt;&gt;();</b>
<b class="nc"><i>914</i>&nbsp;		if (item.getValue() instanceof ProjectImageEntry)</b>
<b class="nc"><i>915</i>&nbsp;			entries.add((ProjectImageEntry&lt;BufferedImage&gt;)item.getValue());</b>
<b class="nc"><i>916</i>&nbsp;		for (TreeItem&lt;?&gt; child : item.getChildren()) {</b>
<b class="nc"><i>917</i>&nbsp;			entries = getImageEntries(child, entries);</b>
<b class="nc"><i>918</i>&nbsp;		}</b>
<b class="nc"><i>919</i>&nbsp;		return entries;</b>
<i>920</i>&nbsp;	}
<i>921</i>&nbsp;	
<i>922</i>&nbsp;	/**
<i>923</i>&nbsp;	 * Gets the value of the entry for the specified key.
<i>924</i>&nbsp;	 * E.g. if key == URI, the value returned will be the entry&#39;s URI.
<i>925</i>&nbsp;	 * This method should be used to get sorting values that
<i>926</i>&nbsp;	 * are not specifically part of an entry&#39;s metadata.
<i>927</i>&nbsp;	 * @param &lt;T&gt;
<i>928</i>&nbsp;	 * @param key
<i>929</i>&nbsp;	 * @return value
<i>930</i>&nbsp;	 * @throws IOException 
<i>931</i>&nbsp;	 */
<i>932</i>&nbsp;	private static &lt;T&gt; String getDefaultValue(ProjectImageEntry&lt;T&gt; entry, String key) throws IOException {
<b class="nc"><i>933</i>&nbsp;		if (key.equals(URI)) {</b>
<b class="nc"><i>934</i>&nbsp;			var URIs = entry.getServerURIs();</b>
<b class="nc"><i>935</i>&nbsp;			var it = URIs.iterator();</b>
<b class="nc"><i>936</i>&nbsp;			if (URIs.size() == 1) {</b>
<b class="nc"><i>937</i>&nbsp;				URI uri = it.next();</b>
<b class="nc"><i>938</i>&nbsp;				String fullURI = uri.getPath();</b>
<b class="nc"><i>939</i>&nbsp;				if (uri.getAuthority() != null)</b>
<b class="nc"><i>940</i>&nbsp;					return &quot;[remote] &quot; + uri.getAuthority() + fullURI;</b>
<b class="nc"><i>941</i>&nbsp;				return fullURI.substring(fullURI.lastIndexOf(&quot;/&quot;)+1, fullURI.length());</b>
<i>942</i>&nbsp;			}
<i>943</i>&nbsp;			else
<b class="nc"><i>944</i>&nbsp;				return &quot;Multiple URIs&quot;;</b>
<i>945</i>&nbsp;		}
<b class="nc"><i>946</i>&nbsp;		return &quot;Undefined&quot;;</b>
<i>947</i>&nbsp;	}
<i>948</i>&nbsp;
<i>949</i>&nbsp;
<i>950</i>&nbsp;
<i>951</i>&nbsp;	Action createSortByKeyAction(final String name, final String key) {
<b class="nc"><i>952</i>&nbsp;		return new Action(name, e -&gt; {</b>
<b class="nc"><i>953</i>&nbsp;			if (model == null)</b>
<b class="nc"><i>954</i>&nbsp;				return;</b>
<b class="nc"><i>955</i>&nbsp;			model.setMetadataKeys(key);</b>
<b class="nc"><i>956</i>&nbsp;			ProjectImageEntry&lt;BufferedImage&gt; entrySelected = getSelectedEntry();</b>
<b class="nc"><i>957</i>&nbsp;			tree.setRoot(model.getRootFX());</b>
<b class="nc"><i>958</i>&nbsp;			tree.getRoot().setExpanded(true);</b>
<b class="nc"><i>959</i>&nbsp;			if (entrySelected != null)</b>
<b class="nc"><i>960</i>&nbsp;				setSelectedEntry(tree, tree.getRoot(), entrySelected);</b>
<b class="nc"><i>961</i>&nbsp;		});</b>
<i>962</i>&nbsp;	}
<i>963</i>&nbsp;
<i>964</i>&nbsp;	
<i>965</i>&nbsp;	/**
<i>966</i>&nbsp;	 * Prompt the user to set a new name for a ProjectImageEntry.
<i>967</i>&nbsp;	 * 
<i>968</i>&nbsp;	 * @param entry
<i>969</i>&nbsp;	 * @return true if the entry was changed, false otherwise.
<i>970</i>&nbsp;	 */
<i>971</i>&nbsp;	private boolean setProjectEntryImageName(final ProjectImageEntry&lt;BufferedImage&gt; entry) {
<b class="nc"><i>972</i>&nbsp;		Project&lt;BufferedImage&gt; project = qupath.getProject();</b>
<b class="nc"><i>973</i>&nbsp;		if (project == null) {</b>
<b class="nc"><i>974</i>&nbsp;			logger.error(&quot;Cannot set image name - project is null&quot;);</b>
<i>975</i>&nbsp;		}
<b class="nc"><i>976</i>&nbsp;		if (entry == null) {</b>
<b class="nc"><i>977</i>&nbsp;			logger.error(&quot;Cannot set image name - entry is null&quot;);</b>
<i>978</i>&nbsp;		}
<i>979</i>&nbsp;		
<b class="nc"><i>980</i>&nbsp;		String name = Dialogs.showInputDialog(&quot;Set Image Name&quot;, &quot;Enter the new image name&quot;, entry.getImageName());</b>
<b class="nc"><i>981</i>&nbsp;		if (name == null)</b>
<b class="nc"><i>982</i>&nbsp;			return false;</b>
<b class="nc"><i>983</i>&nbsp;		if (name.trim().isEmpty() || name.equals(entry.getImageName())) {</b>
<b class="nc"><i>984</i>&nbsp;			logger.warn(&quot;Cannot set image name to {} - will ignore&quot;, name);</b>
<i>985</i>&nbsp;		}
<i>986</i>&nbsp;		
<i>987</i>&nbsp;		// Try to set the name
<b class="nc"><i>988</i>&nbsp;		boolean changed = setProjectEntryImageName(entry, name);</b>
<b class="nc"><i>989</i>&nbsp;		if (changed) {</b>
<b class="nc"><i>990</i>&nbsp;			tree.refresh();</b>
<b class="nc"><i>991</i>&nbsp;			qupath.refreshTitle();</b>
<i>992</i>&nbsp;		}
<b class="nc"><i>993</i>&nbsp;		return changed;</b>
<i>994</i>&nbsp;	}
<i>995</i>&nbsp;	
<i>996</i>&nbsp;	
<i>997</i>&nbsp;	/**
<i>998</i>&nbsp;	 * The the name for a specified ProjectImageEntry.
<i>999</i>&nbsp;	 * 
<i>1000</i>&nbsp;	 * This works hard to do its job... including renaming any data files accordingly.
<i>1001</i>&nbsp;	 * 
<i>1002</i>&nbsp;	 * @param entry
<i>1003</i>&nbsp;	 * @param name
<i>1004</i>&nbsp;	 * @return
<i>1005</i>&nbsp;	 */
<i>1006</i>&nbsp;	private synchronized static &lt;T&gt; boolean setProjectEntryImageName(final ProjectImageEntry&lt;T&gt; entry, final String name) {
<i>1007</i>&nbsp;		
<b class="nc"><i>1008</i>&nbsp;		if (entry.getImageName().equals(name)) {</b>
<b class="nc"><i>1009</i>&nbsp;			logger.warn(&quot;Project image name already set to {} - will be left unchanged&quot;, name);</b>
<b class="nc"><i>1010</i>&nbsp;			return false;</b>
<i>1011</i>&nbsp;		}
<i>1012</i>&nbsp;
<b class="nc"><i>1013</i>&nbsp;		if (name.equals(null)) {</b>
<b class="nc"><i>1014</i>&nbsp;			logger.warn(&quot;Project entry name cannot be null!&quot;);</b>
<b class="nc"><i>1015</i>&nbsp;			return false;</b>
<i>1016</i>&nbsp;		}
<i>1017</i>&nbsp;
<b class="nc"><i>1018</i>&nbsp;		entry.setImageName(name);</b>
<i>1019</i>&nbsp;		
<b class="nc"><i>1020</i>&nbsp;		return true;</b>
<i>1021</i>&nbsp;	}
<i>1022</i>&nbsp;	
<i>1023</i>&nbsp;
<i>1024</i>&nbsp;
<i>1025</i>&nbsp;	// I fully admit this is a horrible design - cobbled together from an earlier Swing version
<i>1026</i>&nbsp;	// TODO: Greatly improve the project tree display...
<i>1027</i>&nbsp;	static class ProjectImageTreeModel {
<i>1028</i>&nbsp;
<i>1029</i>&nbsp;		private Project&lt;?&gt; project;
<b class="fc"><i>1030</i>&nbsp;		private Map&lt;String, List&lt;ProjectImageEntry&lt;?&gt;&gt;&gt; map = new HashMap&lt;&gt;();</b>
<b class="fc"><i>1031</i>&nbsp;		private List&lt;String&gt; mapKeyList = new ArrayList&lt;&gt;();</b>
<i>1032</i>&nbsp;
<b class="fc"><i>1033</i>&nbsp;		private List&lt;String&gt; sortMetadataKeys = new ArrayList&lt;&gt;();</b>
<b class="fc"><i>1034</i>&nbsp;		private List&lt;String&gt; sortDefaultKeys = new ArrayList&lt;&gt;();</b>
<i>1035</i>&nbsp;		private String PROJECT_KEY;
<b class="fc"><i>1036</i>&nbsp;		private String DEFAULT_ROOT = &quot;No project&quot;;</b>
<b class="fc"><i>1037</i>&nbsp;		private String UNASSIGNED_NODE = &quot;(Unassigned)&quot;;</b>
<i>1038</i>&nbsp;		
<i>1039</i>&nbsp;
<i>1040</i>&nbsp;		ProjectImageTreeModel(final Project&lt;?&gt; project) {
<b class="fc"><i>1041</i>&nbsp;			this(project, null);</b>
<b class="fc"><i>1042</i>&nbsp;		}</b>
<i>1043</i>&nbsp;
<i>1044</i>&nbsp;
<b class="fc"><i>1045</i>&nbsp;		ProjectImageTreeModel(final Project&lt;?&gt; project, final String metadataKey) {</b>
<b class="fc"><i>1046</i>&nbsp;			this.project = project;</b>
<b class="fc"><i>1047</i>&nbsp;			if (project == null)</b>
<b class="fc"><i>1048</i>&nbsp;				PROJECT_KEY = &quot;Unnamed project&quot;;</b>
<i>1049</i>&nbsp;			else
<b class="nc"><i>1050</i>&nbsp;				PROJECT_KEY = project.getName();</b>
<b class="fc"><i>1051</i>&nbsp;			if (metadataKey != null)</b>
<b class="nc"><i>1052</i>&nbsp;				setMetadataKeys(metadataKey);</b>
<i>1053</i>&nbsp;			//			rebuildModel();
<b class="fc"><i>1054</i>&nbsp;			sortDefaultKeys.add(URI);</b>
<b class="fc"><i>1055</i>&nbsp;		}</b>
<i>1056</i>&nbsp;
<i>1057</i>&nbsp;		public void setMetadataKeys(final String... metadataSortKeys) {
<b class="nc"><i>1058</i>&nbsp;			sortMetadataKeys.clear();</b>
<b class="nc"><i>1059</i>&nbsp;			if (metadataSortKeys != null) {</b>
<b class="nc"><i>1060</i>&nbsp;				for (String key : metadataSortKeys) {</b>
<b class="nc"><i>1061</i>&nbsp;					if (key != null)</b>
<b class="nc"><i>1062</i>&nbsp;						sortMetadataKeys.add(key);</b>
<i>1063</i>&nbsp;				}
<i>1064</i>&nbsp;			}
<b class="nc"><i>1065</i>&nbsp;			rebuildModel();</b>
<b class="nc"><i>1066</i>&nbsp;		}</b>
<i>1067</i>&nbsp;
<i>1068</i>&nbsp;		public void resetMetadataKeys() {
<b class="nc"><i>1069</i>&nbsp;			setMetadataKeys();</b>
<b class="nc"><i>1070</i>&nbsp;		}</b>
<i>1071</i>&nbsp;
<i>1072</i>&nbsp;		public void rebuildModel() {
<b class="nc"><i>1073</i>&nbsp;			map.clear();</b>
<b class="nc"><i>1074</i>&nbsp;			mapKeyList.clear();</b>
<b class="nc"><i>1075</i>&nbsp;			if (project == null)</b>
<b class="nc"><i>1076</i>&nbsp;				return;</b>
<i>1077</i>&nbsp;
<i>1078</i>&nbsp;			// Populate the map
<b class="nc"><i>1079</i>&nbsp;			String emptyKey = sortMetadataKeys.isEmpty() ? PROJECT_KEY : UNASSIGNED_NODE;</b>
<b class="nc"><i>1080</i>&nbsp;			var imageList = new ArrayList&lt;&gt;(project.getImageList());</b>
<b class="nc"><i>1081</i>&nbsp;			String userFilter = getUserFilter();</b>
<i>1082</i>&nbsp;						
<b class="nc"><i>1083</i>&nbsp;			for (ProjectImageEntry&lt;?&gt; entry : imageList) {</b>
<b class="nc"><i>1084</i>&nbsp;				boolean metadataMatchesFilter = false;</b>
<b class="nc"><i>1085</i>&nbsp;				String localKey = emptyKey;</b>
<b class="nc"><i>1086</i>&nbsp;				for (String sortingKey : sortMetadataKeys) {</b>
<i>1087</i>&nbsp;					try {
<i>1088</i>&nbsp;						String temp;
<b class="nc"><i>1089</i>&nbsp;						if (sortDefaultKeys.contains(sortingKey))</b>
<b class="nc"><i>1090</i>&nbsp;							temp = getDefaultValue(entry, sortingKey);</b>
<i>1091</i>&nbsp;						else
<b class="nc"><i>1092</i>&nbsp;							temp = entry.getMetadataValue(sortingKey);</b>
<i>1093</i>&nbsp;
<b class="nc"><i>1094</i>&nbsp;						if (temp != null) {</b>
<b class="nc"><i>1095</i>&nbsp;							if (temp.toLowerCase().contains(userFilter))</b>
<b class="nc"><i>1096</i>&nbsp;								metadataMatchesFilter = true;</b>
<b class="nc"><i>1097</i>&nbsp;							localKey = temp;</b>
<b class="nc"><i>1098</i>&nbsp;							break;</b>
<i>1099</i>&nbsp;						}
<b class="nc"><i>1100</i>&nbsp;					} catch (IOException e) {</b>
<b class="nc"><i>1101</i>&nbsp;						logger.error(e.toString());</b>
<b class="nc"><i>1102</i>&nbsp;					}</b>
<b class="nc"><i>1103</i>&nbsp;				}</b>
<i>1104</i>&nbsp;
<i>1105</i>&nbsp;				
<b class="nc"><i>1106</i>&nbsp;				List&lt;ProjectImageEntry&lt;?&gt;&gt; list = map.get(localKey);</b>
<b class="nc"><i>1107</i>&nbsp;				if (list == null) {</b>
<b class="nc"><i>1108</i>&nbsp;					list = new ArrayList&lt;&gt;();</b>
<b class="nc"><i>1109</i>&nbsp;					map.put(localKey, list);</b>
<i>1110</i>&nbsp;				}
<i>1111</i>&nbsp;				// Filter out images that do not match the user&#39;s keywords or the entry&#39;s metadata
<b class="nc"><i>1112</i>&nbsp;				if (entry.getImageName().toLowerCase().contains(userFilter) || metadataMatchesFilter)</b>
<b class="nc"><i>1113</i>&nbsp;					list.add(entry);</b>
<b class="nc"><i>1114</i>&nbsp;			}</b>
<i>1115</i>&nbsp;
<i>1116</i>&nbsp;			/*
<i>1117</i>&nbsp;			// Sort all the lists
<i>1118</i>&nbsp;			for (List&lt;ProjectImageEntry&lt;?&gt;&gt; list : map.values()) {
<i>1119</i>&nbsp;				list.sort(new Comparator&lt;ProjectImageEntry&lt;?&gt;&gt;() {
<i>1120</i>&nbsp;					@Override
<i>1121</i>&nbsp;					public int compare(ProjectImageEntry&lt;?&gt; o1, ProjectImageEntry&lt;?&gt; o2) {
<i>1122</i>&nbsp;						return o1.toString().compareTo(o2.toString());
<i>1123</i>&nbsp;					}
<i>1124</i>&nbsp;				});
<i>1125</i>&nbsp;			}
<i>1126</i>&nbsp;			*/
<i>1127</i>&nbsp;
<i>1128</i>&nbsp;			// Populate the key list
<b class="nc"><i>1129</i>&nbsp;			mapKeyList.addAll(map.keySet());</b>
<b class="nc"><i>1130</i>&nbsp;			Collections.sort(mapKeyList);</b>
<i>1131</i>&nbsp;			// Ensure unassigned is at the end
<b class="nc"><i>1132</i>&nbsp;			if (mapKeyList.remove(UNASSIGNED_NODE))</b>
<b class="nc"><i>1133</i>&nbsp;				mapKeyList.add(UNASSIGNED_NODE);</b>
<b class="nc"><i>1134</i>&nbsp;		}</b>
<i>1135</i>&nbsp;		
<i>1136</i>&nbsp;		public boolean matchesUserFilter(String entryMetadata) {
<b class="nc"><i>1137</i>&nbsp;			String userFilter = getUserFilter();</b>
<b class="nc"><i>1138</i>&nbsp;			if (userFilter == null || userFilter.equals(&quot;&quot;)) </b>
<b class="nc"><i>1139</i>&nbsp;				return true;</b>
<b class="nc"><i>1140</i>&nbsp;			if (entryMetadata.toLowerCase().contains(userFilter))</b>
<b class="nc"><i>1141</i>&nbsp;				return true;</b>
<b class="nc"><i>1142</i>&nbsp;			return false;</b>
<i>1143</i>&nbsp;		}
<i>1144</i>&nbsp;		
<i>1145</i>&nbsp;		
<i>1146</i>&nbsp;		/**
<i>1147</i>&nbsp;		 * This method should be used instead of calling Project.getImageList() 
<i>1148</i>&nbsp;		 * when we need the list of {@code ImageProjectEntry}s within a project  
<i>1149</i>&nbsp;		 * after having filtered out the entries with the key words provided by 
<i>1150</i>&nbsp;		 * the user.
<i>1151</i>&nbsp;		 * @return {@code List&lt;ProjectImageEntry&gt;}
<i>1152</i>&nbsp;		 */
<i>1153</i>&nbsp;		public List&lt;ProjectImageEntry&lt;?&gt;&gt; getImageList(){
<b class="nc"><i>1154</i>&nbsp;			List&lt;ProjectImageEntry&lt;?&gt;&gt; out = </b>
<b class="nc"><i>1155</i>&nbsp;				    map.values().stream()</b>
<b class="nc"><i>1156</i>&nbsp;				        .flatMap(List::stream)</b>
<b class="nc"><i>1157</i>&nbsp;				        .collect(Collectors.toList());</b>
<b class="nc"><i>1158</i>&nbsp;			return out;</b>
<i>1159</i>&nbsp;		}
<i>1160</i>&nbsp;
<i>1161</i>&nbsp;
<i>1162</i>&nbsp;		public TreeItem&lt;Object&gt; getRootFX() {
<b class="nc"><i>1163</i>&nbsp;			rebuildModel();</b>
<i>1164</i>&nbsp;			
<i>1165</i>&nbsp;			// If we are masking the image names, we should also shuffle the entries
<b class="nc"><i>1166</i>&nbsp;			boolean maskNames = PathPrefs.maskImageNamesProperty().get();</b>
<i>1167</i>&nbsp;			
<b class="nc"><i>1168</i>&nbsp;			TreeItem&lt;Object&gt; root = new TreeItem&lt;&gt;(getRoot());</b>
<b class="nc"><i>1169</i>&nbsp;			List&lt;TreeItem&lt;Object&gt;&gt; items = root.getChildren();</b>
<b class="nc"><i>1170</i>&nbsp;			if (project != null) {</b>
<b class="nc"><i>1171</i>&nbsp;				Random rand = new Random(project.hashCode());</b>
<b class="nc"><i>1172</i>&nbsp;				if (sortMetadataKeys.isEmpty()) {</b>
<b class="nc"><i>1173</i>&nbsp;					var imageList = getImageList();</b>
<b class="nc"><i>1174</i>&nbsp;					if (maskNames)</b>
<b class="nc"><i>1175</i>&nbsp;						Collections.shuffle(imageList, rand);</b>
<b class="nc"><i>1176</i>&nbsp;					for (ProjectImageEntry&lt;?&gt; entry : imageList)</b>
<b class="nc"><i>1177</i>&nbsp;						items.add(new TreeItem&lt;&gt;(entry));</b>
<b class="nc"><i>1178</i>&nbsp;				} else {</b>
<b class="nc"><i>1179</i>&nbsp;					for (String key : mapKeyList) {</b>
<b class="nc"><i>1180</i>&nbsp;						TreeItem&lt;Object&gt; item = new TreeItem&lt;&gt;(key);</b>
<b class="nc"><i>1181</i>&nbsp;						var imageList = map.get(key);</b>
<b class="nc"><i>1182</i>&nbsp;						if (maskNames)</b>
<b class="nc"><i>1183</i>&nbsp;							Collections.shuffle(imageList, rand);</b>
<b class="nc"><i>1184</i>&nbsp;						for (ProjectImageEntry&lt;?&gt; entry : imageList)</b>
<b class="nc"><i>1185</i>&nbsp;							item.getChildren().add(new TreeItem&lt;&gt;(entry));</b>
<b class="nc"><i>1186</i>&nbsp;						items.add(item);</b>
<b class="nc"><i>1187</i>&nbsp;					}</b>
<i>1188</i>&nbsp;				}
<i>1189</i>&nbsp;			}
<b class="nc"><i>1190</i>&nbsp;			return root;</b>
<i>1191</i>&nbsp;		}
<i>1192</i>&nbsp;
<i>1193</i>&nbsp;
<i>1194</i>&nbsp;
<i>1195</i>&nbsp;		public Object getRoot() {
<b class="nc"><i>1196</i>&nbsp;			return project == null ? DEFAULT_ROOT : PROJECT_KEY;</b>
<i>1197</i>&nbsp;		}
<i>1198</i>&nbsp;
<i>1199</i>&nbsp;		public Object getChild(Object parent, int index) {
<i>1200</i>&nbsp;			//			if (parent == project &amp;&amp; project != null)
<i>1201</i>&nbsp;			//				return project.getImageList().get(index);
<i>1202</i>&nbsp;
<b class="nc"><i>1203</i>&nbsp;			if (project == null)</b>
<b class="nc"><i>1204</i>&nbsp;				return null;</b>
<b class="nc"><i>1205</i>&nbsp;			if (parent == PROJECT_KEY &amp;&amp; !sortMetadataKeys.isEmpty())</b>
<b class="nc"><i>1206</i>&nbsp;				return mapKeyList.get(index);</b>
<b class="nc"><i>1207</i>&nbsp;			List&lt;ProjectImageEntry&lt;?&gt;&gt; list = map.get(parent);</b>
<b class="nc"><i>1208</i>&nbsp;			return list.get(index);</b>
<i>1209</i>&nbsp;		}
<i>1210</i>&nbsp;
<i>1211</i>&nbsp;		public int getChildCount(Object parent) {
<b class="nc"><i>1212</i>&nbsp;			if (project == null)</b>
<b class="nc"><i>1213</i>&nbsp;				return 0;</b>
<b class="nc"><i>1214</i>&nbsp;			if (parent == PROJECT_KEY &amp;&amp; !sortMetadataKeys.isEmpty())</b>
<b class="nc"><i>1215</i>&nbsp;				return map.size();</b>
<b class="nc"><i>1216</i>&nbsp;			List&lt;ProjectImageEntry&lt;?&gt;&gt; list = map.get(parent);</b>
<b class="nc"><i>1217</i>&nbsp;			return list == null ? 0 : list.size();</b>
<i>1218</i>&nbsp;		}
<i>1219</i>&nbsp;
<i>1220</i>&nbsp;		public boolean isLeaf(Object node) {
<b class="nc"><i>1221</i>&nbsp;			return node instanceof ProjectImageEntry;</b>
<i>1222</i>&nbsp;		}
<i>1223</i>&nbsp;
<i>1224</i>&nbsp;		public int getIndexOfChild(Object parent, Object child) {
<b class="nc"><i>1225</i>&nbsp;			if (project == null)</b>
<b class="nc"><i>1226</i>&nbsp;				return -1;</b>
<b class="nc"><i>1227</i>&nbsp;			if (parent == PROJECT_KEY &amp;&amp; !sortMetadataKeys.isEmpty())</b>
<b class="nc"><i>1228</i>&nbsp;				return mapKeyList.indexOf(child);</b>
<b class="nc"><i>1229</i>&nbsp;			List&lt;ProjectImageEntry&lt;?&gt;&gt; list = map.get(parent);</b>
<b class="nc"><i>1230</i>&nbsp;			return list == null ? -1 : list.indexOf(child);</b>
<i>1231</i>&nbsp;		}
<i>1232</i>&nbsp;
<i>1233</i>&nbsp;	}
<i>1234</i>&nbsp;
<i>1235</i>&nbsp;
<i>1236</i>&nbsp;
<i>1237</i>&nbsp;
<b class="fc"><i>1238</i>&nbsp;	static enum ProjectThumbnailSize {</b>
<b class="fc"><i>1239</i>&nbsp;		SMALL, MEDIUM, LARGE;</b>
<i>1240</i>&nbsp;		
<i>1241</i>&nbsp;		private double defaultHeight = 40;
<i>1242</i>&nbsp;		private double defaultWidth = 50;
<i>1243</i>&nbsp;		
<i>1244</i>&nbsp;		@Override
<i>1245</i>&nbsp;		public String toString() {
<b class="pc"><i>1246</i>&nbsp;			switch(this) {</b>
<i>1247</i>&nbsp;			case LARGE:
<b class="nc"><i>1248</i>&nbsp;				return &quot;Large&quot;;</b>
<i>1249</i>&nbsp;			case MEDIUM:
<b class="nc"><i>1250</i>&nbsp;				return &quot;Medium&quot;;</b>
<i>1251</i>&nbsp;			case SMALL:
<b class="nc"><i>1252</i>&nbsp;				return &quot;Small&quot;;</b>
<i>1253</i>&nbsp;			default:
<b class="nc"><i>1254</i>&nbsp;				return super.toString();</b>
<i>1255</i>&nbsp;			}
<i>1256</i>&nbsp;		}
<i>1257</i>&nbsp;		
<i>1258</i>&nbsp;		public double getWidth() {
<b class="fc"><i>1259</i>&nbsp;			switch(this) {</b>
<i>1260</i>&nbsp;			case LARGE:
<b class="nc"><i>1261</i>&nbsp;				return defaultWidth * 3.0;</b>
<i>1262</i>&nbsp;			case MEDIUM:
<b class="nc"><i>1263</i>&nbsp;				return defaultWidth * 2.0;</b>
<i>1264</i>&nbsp;			case SMALL:
<i>1265</i>&nbsp;			default:
<b class="fc"><i>1266</i>&nbsp;				return defaultWidth;</b>
<i>1267</i>&nbsp;			}
<i>1268</i>&nbsp;		}
<i>1269</i>&nbsp;		
<i>1270</i>&nbsp;		public double getHeight() {
<b class="fc"><i>1271</i>&nbsp;			switch(this) {</b>
<i>1272</i>&nbsp;			case LARGE:
<b class="nc"><i>1273</i>&nbsp;				return defaultHeight * 3.0;</b>
<i>1274</i>&nbsp;			case MEDIUM:
<b class="nc"><i>1275</i>&nbsp;				return defaultHeight * 2.0;</b>
<i>1276</i>&nbsp;			case SMALL:
<i>1277</i>&nbsp;			default:
<b class="fc"><i>1278</i>&nbsp;				return defaultHeight;</b>
<i>1279</i>&nbsp;			}
<i>1280</i>&nbsp;		}
<i>1281</i>&nbsp;	}
<i>1282</i>&nbsp;	
<i>1283</i>&nbsp;
<i>1284</i>&nbsp;	class ImageEntryCell extends TreeCell&lt;Object&gt; {
<i>1285</i>&nbsp;
<b class="fc"><i>1286</i>&nbsp;		final SimpleDateFormat dateFormat = new SimpleDateFormat();</b>
<i>1287</i>&nbsp;		
<b class="fc"><i>1288</i>&nbsp;		private Tooltip tooltip = new Tooltip();</b>
<b class="fc"><i>1289</i>&nbsp;		private StackPane label = new StackPane();</b>
<b class="fc"><i>1290</i>&nbsp;		private ImageView viewTooltip = new ImageView();</b>
<b class="fc"><i>1291</i>&nbsp;		private Canvas viewCanvas = new Canvas();</b>
<i>1292</i>&nbsp;		
<b class="fc"><i>1293</i>&nbsp;		private DoubleBinding viewWidth = Bindings.createDoubleBinding(</b>
<b class="fc"><i>1294</i>&nbsp;				() -&gt; thumbnailSize.get().getWidth(),</b>
<i>1295</i>&nbsp;				thumbnailSize);
<i>1296</i>&nbsp;
<b class="fc"><i>1297</i>&nbsp;		private DoubleBinding viewHeight = Bindings.createDoubleBinding(</b>
<b class="fc"><i>1298</i>&nbsp;				() -&gt; thumbnailSize.get().getHeight(),</b>
<i>1299</i>&nbsp;				thumbnailSize);
<i>1300</i>&nbsp;
<b class="fc"><i>1301</i>&nbsp;		public ImageEntryCell() {</b>
<b class="fc"><i>1302</i>&nbsp;			viewTooltip.setFitHeight(250);</b>
<b class="fc"><i>1303</i>&nbsp;			viewTooltip.setFitWidth(250);</b>
<b class="fc"><i>1304</i>&nbsp;			viewTooltip.setPreserveRatio(true);</b>
<b class="fc"><i>1305</i>&nbsp;			viewCanvas.widthProperty().bind(viewWidth);</b>
<b class="fc"><i>1306</i>&nbsp;			viewCanvas.heightProperty().bind(viewHeight);</b>
<b class="fc"><i>1307</i>&nbsp;			viewCanvas.setStyle(&quot;-fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.5), 4, 0, 1, 1);&quot;);</b>
<b class="fc"><i>1308</i>&nbsp;			label.getChildren().add(viewCanvas);</b>
<b class="fc"><i>1309</i>&nbsp;			label.prefWidthProperty().bind(viewCanvas.widthProperty());</b>
<b class="fc"><i>1310</i>&nbsp;			label.prefHeightProperty().bind(viewCanvas.heightProperty());</b>
<i>1311</i>&nbsp;			
<i>1312</i>&nbsp;//			setOnDragDetected( event -&gt;  {
<i>1313</i>&nbsp;//				if (isEmpty())
<i>1314</i>&nbsp;//					return;
<i>1315</i>&nbsp;//				Object item = getItem();
<i>1316</i>&nbsp;//				String path = null;
<i>1317</i>&nbsp;//				if (item instanceof ProjectImageEntry&lt;?&gt;)
<i>1318</i>&nbsp;//					path = ((ProjectImageEntry)item).getServerPath();
<i>1319</i>&nbsp;//				if (path == null)
<i>1320</i>&nbsp;//					return;
<i>1321</i>&nbsp;//				Dragboard db = startDragAndDrop(TransferMode.COPY);
<i>1322</i>&nbsp;//				ClipboardContent cc = new ClipboardContent();
<i>1323</i>&nbsp;//				cc.putString(path);
<i>1324</i>&nbsp;//				db.setContent(cc);
<i>1325</i>&nbsp;//				db.setDragView(snapshot(null, null));
<i>1326</i>&nbsp;//            });
<b class="fc"><i>1327</i>&nbsp;		}</b>
<i>1328</i>&nbsp;
<i>1329</i>&nbsp;		@Override
<i>1330</i>&nbsp;		protected void updateItem(Object item, boolean empty) {
<b class="fc"><i>1331</i>&nbsp;			super.updateItem(item, empty);</b>
<i>1332</i>&nbsp;
<b class="fc"><i>1333</i>&nbsp;			if (item == null || empty) {</b>
<b class="fc"><i>1334</i>&nbsp;				setText(null);</b>
<b class="fc"><i>1335</i>&nbsp;				setGraphic(null);</b>
<b class="fc"><i>1336</i>&nbsp;				setTooltip(null);</b>
<b class="fc"><i>1337</i>&nbsp;				return;</b>
<i>1338</i>&nbsp;			}
<i>1339</i>&nbsp;
<b class="nc"><i>1340</i>&nbsp;			ProjectImageEntry&lt;BufferedImage&gt; entry = item instanceof ProjectImageEntry ? (ProjectImageEntry&lt;BufferedImage&gt;)item : null;</b>
<b class="nc"><i>1341</i>&nbsp;			if (isCurrentImage(entry))</b>
<b class="nc"><i>1342</i>&nbsp;				setStyle(&quot;-fx-font-weight: bold; -fx-font-family: arial&quot;);</b>
<b class="nc"><i>1343</i>&nbsp;			else if (entry == null || entry.hasImageData())</b>
<b class="nc"><i>1344</i>&nbsp;				setStyle(&quot;-fx-font-weight: normal; -fx-font-family: arial&quot;);</b>
<i>1345</i>&nbsp;			else
<b class="nc"><i>1346</i>&nbsp;				setStyle(&quot;-fx-font-style: italic; -fx-font-family: arial&quot;);</b>
<i>1347</i>&nbsp;			
<b class="nc"><i>1348</i>&nbsp;			if (entry == null) {</b>
<b class="nc"><i>1349</i>&nbsp;				setText(item.toString() + &quot; (&quot; + getTreeItem().getChildren().size() + &quot;)&quot;);</b>
<b class="nc"><i>1350</i>&nbsp;				tooltip.setText(item.toString());</b>
<b class="nc"><i>1351</i>&nbsp;				setTooltip(tooltip);</b>
<b class="nc"><i>1352</i>&nbsp;				setGraphic(null);</b>
<i>1353</i>&nbsp;			} else {
<i>1354</i>&nbsp;				// Set whatever tooltip we have
<b class="nc"><i>1355</i>&nbsp;				tooltip.setGraphic(null);</b>
<b class="nc"><i>1356</i>&nbsp;				setTooltip(tooltip);</b>
<i>1357</i>&nbsp;
<b class="nc"><i>1358</i>&nbsp;				setText(entry.getImageName());</b>
<i>1359</i>&nbsp;				//	        	 String s = entry.toString();
<i>1360</i>&nbsp;				//	        	 File file = getImageDataPath(entry);
<i>1361</i>&nbsp;				//	        	 if (file != null &amp;&amp; file.exists()) {
<i>1362</i>&nbsp;				//	        		 double sizeMB = file.length() / 1024.0 / 1024.0;
<i>1363</i>&nbsp;				//	        		 s = String.format(&quot;%s (%.2f MB)&quot;, s, sizeMB);
<i>1364</i>&nbsp;				//	        	 }
<i>1365</i>&nbsp;
<b class="nc"><i>1366</i>&nbsp;				tooltip.setText(entry.getSummary());</b>
<i>1367</i>&nbsp;				//	        	 Tooltip tooltip = new Tooltip(sb.toString());
<i>1368</i>&nbsp;
<b class="nc"><i>1369</i>&nbsp;				BufferedImage img = null;</b>
<i>1370</i>&nbsp;				try {
<b class="nc"><i>1371</i>&nbsp;					img = (BufferedImage)entry.getThumbnail();</b>
<b class="nc"><i>1372</i>&nbsp;				} catch (Exception e) {</b>
<b class="nc"><i>1373</i>&nbsp;					logger.warn(&quot;Unable to read thumbnail for {} ({})&quot; + entry.getImageName(), e.getLocalizedMessage());</b>
<b class="nc"><i>1374</i>&nbsp;				}</b>
<i>1375</i>&nbsp;				
<b class="nc"><i>1376</i>&nbsp;				if (img != null) {</b>
<b class="nc"><i>1377</i>&nbsp;					Image image = SwingFXUtils.toFXImage(img, null);</b>
<b class="nc"><i>1378</i>&nbsp;					viewTooltip.setImage(image);</b>
<b class="nc"><i>1379</i>&nbsp;					tooltip.setGraphic(viewTooltip);</b>
<b class="nc"><i>1380</i>&nbsp;					GuiTools.paintImage(viewCanvas, image);</b>
<b class="nc"><i>1381</i>&nbsp;					if (getGraphic() == null)</b>
<b class="nc"><i>1382</i>&nbsp;						setGraphic(label);</b>
<b class="nc"><i>1383</i>&nbsp;				} else {</b>
<b class="nc"><i>1384</i>&nbsp;					setGraphic(null);</b>
<i>1385</i>&nbsp;				}
<i>1386</i>&nbsp;			}
<i>1387</i>&nbsp;			
<b class="nc"><i>1388</i>&nbsp;		}</b>
<i>1389</i>&nbsp;	}
<i>1390</i>&nbsp;}
</div>
</div>

<div class="footer">
    
    <div style="float:right;">generated on 2021-01-25 09:46</div>
</div>
</body>
</html>
